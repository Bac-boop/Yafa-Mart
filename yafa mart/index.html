<!--
Katalog Kelontong - Yafa Mart (Upgraded)
Single-file HTML (responsive)

Features included:
- Connect to Google Sheet via SheetDB / Sheety (set SHEET_API)
- Fallback to embedded 200-sample products for demo
- Lazy-load images
- Pagination (load 20 items per page with "Load more")
- Fast client-side search + category filter
- Loading skeleton while fetching
- Cart persist in localStorage
- Checkout opens WhatsApp with formatted COD message
- Auto-reduce stock in local simulation; when using SheetDB you'll need to enable PATCH and provide SHEET_API

Instructions (short):
1) Edit ADMIN_WHATSAPP variable to your WA number (format: 628123...)
2) If you want live Google Sheet, create sheet and connect via SheetDB/Sheety and paste API URL into SHEET_API variable.
3) Open file in browser (or host on GitHub Pages) — works offline with embedded sample data.

NOTE: Do NOT share this file publicly while it contains your real admin WhatsApp number.
-->

<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Yafa Mart - Katalog</title>
  <style>
    :root{--accent:#0b6efd;--muted:#6b7280;--card:#ffffff}
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;margin:0;background:#f3f4f6;color:#111}
    header{background:var(--card);padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;box-shadow:0 1px 6px rgba(2,6,23,0.06)}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:44px;height:44px;background:linear-gradient(135deg,var(--accent),#06b6d4);border-radius:8px;display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
    main{max-width:1100px;margin:16px auto;padding:0 12px;display:grid;grid-template-columns:320px 1fr;gap:16px}
    .panel{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 1px 6px rgba(2,6,23,0.03)}
    .search input{width:100%;padding:10px;border-radius:8px;border:1px solid #e5e7eb}
    .categories{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .chip{padding:8px 10px;border-radius:999px;background:#f8fafc;border:1px solid #e6eef6;cursor:pointer;font-size:14px}
    .chip.active{background:var(--accent);color:white}
    .products{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
    .card{background:white;border-radius:10px;padding:10px;display:flex;flex-direction:column;gap:8px;border:1px solid #eef2ff}
    .img{height:140px;background:#eef2ff;border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .img img{width:100%;height:100%;object-fit:cover}
    .meta{display:flex;justify-content:space-between;align-items:center}
    .price{font-weight:700}
    .btn{background:var(--accent);color:white;padding:8px 10px;border-radius:8px;border:none;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid #dbeafe}
    .cart{position:fixed;right:18px;bottom:18px;background:var(--accent);color:white;padding:12px 16px;border-radius:999px;box-shadow:0 8px 20px rgba(11,110,253,0.18);cursor:pointer}
    .cart-count{background:#ff4636;padding:4px 8px;border-radius:999px;margin-left:8px;font-weight:700}

    /* mobile */
    @media (max-width:900px){main{grid-template-columns:1fr;padding:12px} .panel.left{order:2}}

    /* skeleton */
    .skeleton{background:linear-gradient(90deg,#edf2ff 25%,#f8fafc 50%,#edf2ff 75%);background-size:200% 100%;animation:shimmer 1.2s linear infinite;border-radius:8px}
    @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

    footer{max-width:1100px;margin:12px auto;padding:8px;text-align:center;color:var(--muted)}

    .load-more{display:block;margin:14px auto;padding:10px 14px;border-radius:8px;border:1px solid #e6eef6;background:white;cursor:pointer}
    .topbar-right{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
  <header>
    <div class="brand"><div class="logo">YM</div>
      <div>
        <div style="font-weight:700">Yafa Mart</div>
        <div style="font-size:13px;color:var(--muted)">Katalog Online — COD via WhatsApp</div>
      </div>
    </div>
    <div class="topbar-right">
      <button class="btn" id="exportCsv">Export CSV</button>
      <div style="font-size:13px;color:var(--muted)">Admin WA: <span id="adminWaLabel">-</span></div>
    </div>
  </header>

  <main>
    <aside class="panel left">
      <div class="search"><input id="q" placeholder="Cari produk... contoh: beras, minyak" /></div>
      <div class="categories" id="categories"></div>
      <hr style="margin:12px 0" />
      <div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Keranjang</div>
          <div class="small" id="cart-summary">0 item</div>
        </div>
        <div id="cart-items" style="margin-top:8px"></div>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn" id="checkoutBtn">Checkout via WhatsApp</button>
          <button class="btn ghost" id="clearCart">Kosongkan</button>
        </div>
      </div>
    </aside>

    <section class="panel right">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div style="font-weight:700">Daftar Produk</div>
        <div style="font-size:13px;color:var(--muted)">Tampilkan <span id="visibleCount">0</span> dari <span id="totalCount">0</span></div>
      </div>
      <div class="products" id="products"></div>
      <button id="loadMore" class="load-more">Muat lebih banyak</button>
    </section>
  </main>

  <button class="cart" id="floatingCart">Keranjang <span class="cart-count" id="floatingCount">0</span></button>

  <footer>
    <div style="font-size:13px;color:var(--muted)">Demo katalog Yafa Mart. Untuk live, hubungkan Google Sheet via SheetDB/Sheety dan masukkan API URL di konfigurasi.</div>
  </footer>

  <script>
    /***** CONFIG - EDIT THIS *****/
    const ADMIN_WHATSAPP = '6285816381285'; // <-- ganti dengan nomor admin (contoh: 62812xxxx)
    const SHOP_NAME = 'Yafa Mart';
    const SHEET_API = 'https://sheetdb.io/api/v1/rcorje2n3osn1'; // <-- kalau pakai SheetDB/Sheety: paste URL di sini, contoh: https://sheetdb.io/api/v1/abcd1234
    const USE_SHEET = !!SHEET_API;
    const PAGE_SIZE = 20;
    /***** END CONFIG *****/

    document.getElementById('adminWaLabel').textContent = ADMIN_WHATSAPP;

    // helper
    function formatRp(n){ return 'Rp ' + Number(n).toLocaleString('id-ID'); }

    // sample product generator (200 items) - used as fallback/demo
    const SAMPLE_PRODUCTS = (function(){
      const cats = ["Sembako","Minuman","Makanan Ringan","Bumbu Dapur","Kebersihan","Kebutuhan Bayi","Gas / Galon","Lainnya"];
      const items = [];
      for(let i=1;i<=200;i++){
        const id = 'P'+String(i).padStart(3,'0');
        const cat = cats[Math.floor(Math.random()*cats.length)];
        let name,unit,price;
        switch(cat){
          case 'Sembako': name = ['Beras Ramos 5kg','Beras Premium 5kg','Tepung Terigu 1kg'][Math.floor(Math.random()*3)]; unit='pak'; price=[72000,92000,9000][Math.floor(Math.random()*3)]; break;
          case 'Minuman': name = ['Minyak Goreng 2L','Susu UHT 1L','Kopi Instan 200g'][Math.floor(Math.random()*3)]; unit='pcs'; price=[28000,15000,32000][Math.floor(Math.random()*3)]; break;
          case 'Makanan Ringan': name = ['Indomie Goreng 1 pcs','Biskuit Marie 200g','Kacang Goreng 200g'][Math.floor(Math.random()*3)]; unit='pcs'; price=[3000,8500,15000][Math.floor(Math.random()*3)]; break;
          case 'Bumbu Dapur': name = ['Gula Pasir 1kg','Garam 1kg','Kecap Manis 600ml'][Math.floor(Math.random()*3)]; unit='pcs'; price=[12500,6000,20000][Math.floor(Math.random()*3)]; break;
          case 'Kebersihan': name = ['Detergen 1kg','Sabun Mandi 1pcs','Kertas Tisu 1 pack'][Math.floor(Math.random()*3)]; unit='pcs'; price=[22000,7000,8000][Math.floor(Math.random()*3)]; break;
          case 'Kebutuhan Bayi': name = ['Popok S M L','Susu Bayi 400g','Baby Wipes 72s'][Math.floor(Math.random()*3)]; unit='pak'; price=[55000,75000,15000][Math.floor(Math.random()*3)]; break;
          case 'Gas / Galon': name = ['Tabung Gas 3kg','Galon Air 19L'][Math.floor(Math.random()*2)]; unit='pcs'; price=[150000,20000][Math.floor(Math.random()*2)]; break;
          default: name = 'Produk '+i; unit='pcs'; price=Math.floor(2000+Math.random()*50000);
        }
        const stok = Math.floor(5+Math.random()*120);
        const img = 'https://picsum.photos/seed/'+id+'/400/300';
        items.push({id:id,name:name,price:price,satuan:unit,stok:stok,gambar:img,kategori:cat,deskripsi: name + ' - Produk ' + id});
      }
      return items;
    })();

    // state
    let PRODUCTS = [];
    let displayOffset = 0;
    const CART_KEY = 'yafa_cart_v1';
    const STOCK_KEY = 'yafa_stock_v1';

    // storage helpers
    function loadCart(){ try{ return JSON.parse(localStorage.getItem(CART_KEY) || '[]'); }catch(e){return []} }
    function saveCart(c){ localStorage.setItem(CART_KEY,JSON.stringify(c)); renderCart(); updateFloating(); }
    function loadStockState(){ try{ const raw = localStorage.getItem(STOCK_KEY); if(!raw) return false; const arr = JSON.parse(raw); arr.forEach(s=>{ const p=PRODUCTS.find(x=>x.id===s.id); if(p) p.stok=s.stok }); return true }catch(e){return false} }
    function saveStockState(){ const stock = PRODUCTS.map(p=>({id:p.id,stok:p.stok})); localStorage.setItem(STOCK_KEY,JSON.stringify(stock)); }

    // rendering
    function setSkeleton(target,count=6){ const container = document.getElementById(target); container.innerHTML=''; for(let i=0;i<count;i++){ const card = document.createElement('div'); card.className='card'; card.innerHTML = '<div class="img skeleton" style="height:120px"></div><div class="skeleton" style="height:16px;width:60%"></div><div class="skeleton" style="height:12px;width:40%"></div>'; container.appendChild(card); } }

    function renderProductsChunk(){ const container = document.getElementById('products'); const chunk = PRODUCTS.slice(displayOffset, displayOffset + PAGE_SIZE); chunk.forEach(p=>{ const el = document.createElement('div'); el.className='card'; el.innerHTML = `
      <div class="img"><img loading="lazy" src="${p.gambar}" alt="${p.name}" onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'"></div>
      <div style="font-weight:700">${p.name}</div>
      <div style="font-size:13px;color:var(--muted)">${p.deskripsi||''}</div>
      <div class="meta">
        <div class="price">${formatRp(p.price)} <div style="font-size:12px;color:var(--muted);display:inline">/ ${p.satuan||'pcs'}</div></div>
        <div style="font-size:13px;color:var(--muted)">Stok: ${p.stok}</div>
      </div>
      <div style="display:flex;gap:8px;margin-top:6px;align-items:center">
        <input type="number" min="1" value="1" style="width:70px;padding:6px;border-radius:6px;border:1px solid #eef5ff" id="qty_${p.id}" />
        <button class="btn" data-id="${p.id}">Tambah</button>
      </div>
    `; container.appendChild(el); });
      // attach add handlers
      document.querySelectorAll('.card .btn').forEach(b=>{ if(!b._attached){ b._attached = true; b.addEventListener('click',()=>{ const id=b.getAttribute('data-id'); const qty = parseInt(document.getElementById('qty_'+id).value) || 1; addToCart(id,qty); }); } });
      displayOffset += chunk.length; updateCounts();
      // hide load more if end
      document.getElementById('loadMore').style.display = displayOffset >= PRODUCTS.length ? 'none' : 'block';
    }

    function updateCounts(){ document.getElementById('visibleCount').textContent = Math.min(displayOffset, PRODUCTS.length); document.getElementById('totalCount').textContent = PRODUCTS.length; }

    function renderCategories(){ const cats = Array.from(new Set(PRODUCTS.map(p=>p.kategori))).sort(); const container = document.getElementById('categories'); container.innerHTML=''; const all = document.createElement('div'); all.className='chip active'; all.textContent='Semua'; all.dataset.cat=''; container.appendChild(all); cats.forEach(c=>{ const el=document.createElement('div'); el.className='chip'; el.textContent=c; el.dataset.cat=c; container.appendChild(el); }); container.querySelectorAll('.chip').forEach(ch=> ch.addEventListener('click',()=>{ container.querySelectorAll('.chip').forEach(x=>x.classList.remove('active')); ch.classList.add('active'); applyFilters(true); })); }

    function applyFilters(resetOffset=false){ const q = document.getElementById('q').value.trim().toLowerCase(); const active = document.querySelector('.chip.active')?.dataset?.cat || ''; let filtered = PRODUCTS.filter(p=> (active==='' || p.kategori===active) && (p.name.toLowerCase().includes(q) || (p.deskripsi||'').toLowerCase().includes(q)) ); // replace products shown by filtered
      // re-render
      displayOffset = 0; const container = document.getElementById('products'); container.innerHTML = ''; PRODUCTS = filtered.concat([]); // make PRODUCTS equal filtered for paging
      renderProductsChunk(); }

    // cart
    function addToCart(id,qty){ const p = PRODUCTS.find(x=>x.id===id); if(!p) return alert('Produk tidak ditemukan'); if(qty>p.stok) return alert('Stok tidak cukup'); const cart = loadCart(); const item = cart.find(i=>i.id===id); if(item){ if(item.qty+qty > p.stok) return alert('Jumlah melebihi stok'); item.qty += qty } else cart.push({id:id,name:p.name,price:p.price,unit:p.satuan||'pcs',qty:qty}); saveCart(cart); alert('Produk ditambahkan ke keranjang'); }

    function renderCart(){ const container = document.getElementById('cart-items'); const cart = loadCart(); container.innerHTML=''; if(cart.length===0){ container.innerHTML='<div style="color:var(--muted)">Keranjang kosong</div>'; document.getElementById('cart-summary').textContent='0 item'; return } cart.forEach(i=>{ const p = PRODUCTS.find(x=>x.id===i.id) || {}; const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.gap='8px'; row.style.padding='6px 0'; row.innerHTML = `<div><div style="font-weight:700">${i.name}</div><div style="font-size:13px;color:var(--muted)">${i.qty} x ${formatRp(i.price)} / ${i.unit}</div></div><div style="text-align:right"><div style="font-weight:700">${formatRp(i.qty*i.price)}</div><div style="margin-top:6px"><button class="btn ghost" data-id="remove_${i.id}">Hapus</button></div></div>`; container.appendChild(row); }); container.querySelectorAll('button[data-id^="remove_"]').forEach(b=> b.addEventListener('click',()=>{ const id=b.dataset.id.replace('remove_',''); removeFromCart(id) })); const total = cart.reduce((s,i)=>s + i.price*i.qty,0); document.getElementById('cart-summary').textContent = `${cart.length} item — ${formatRp(total)}`; }

    function removeFromCart(id){ const cart = loadCart().filter(i=>i.id!==id); saveCart(cart); }

    document.getElementById('clearCart').addEventListener('click',()=>{ if(confirm('Kosongkan keranjang?')){ saveCart([]) } });

    // checkout
    document.getElementById('checkoutBtn').addEventListener('click',()=> doCheckout());
    document.getElementById('floatingCart').addEventListener('click',()=> window.scrollTo({top:0,behavior:'smooth'}));

    async function doCheckout(){ const cart = loadCart(); if(cart.length===0) return alert('Keranjang kosong'); const name = prompt('Nama pembeli (untuk nota):'); if(!name) return alert('Nama dibutuhkan'); const address = prompt('Alamat lengkap pengiriman:'); if(!address) return alert('Alamat dibutuhkan'); const note = prompt('Catatan (opsional):',''); // build message
      let text = `*Pesanan dari ${SHOP_NAME}*
Nama: ${name}
Alamat: ${address}

*Detail Pesanan:*
`;
      cart.forEach(i=>{ text += `- ${i.name} x ${i.qty} = ${formatRp(i.qty*i.price)}
`; });
      const subtotal = cart.reduce((s,i)=>s+i.qty*i.price,0);
      text += `
Subtotal: ${formatRp(subtotal)}
Metode: COD
${note?('
Catatan: '+note+'
'):''}
Terima kasih!`;

      // If using sheet API, attempt to PATCH stock (requires SheetDB/PATCH enabled)
      if(SHEET_API){ try{ await reduceStockRemote(cart); }catch(e){ console.warn('reduceStockRemote failed',e); } }
      // local stock decrement for demo
      cart.forEach(i=>{ const p = PRODUCTS.find(x=>x.id===i.id); if(p) p.stok = Math.max(0,p.stok - i.qty); });
      saveStockState(); saveCart([]);
      // open whatsapp
      const wa = `https://wa.me/${ADMIN_WHATSAPP}?text=` + encodeURIComponent(text);
      window.open(wa,'_blank');
      // refresh UI
      const prodContainer = document.getElementById('products'); prodContainer.innerHTML=''; displayOffset=0; renderProductsChunk(); renderCart(); updateFloating(); }

    async function reduceStockRemote(cart){ // expects SheetDB style API: PATCH /id/{id}
      for(const item of cart){ const url = SHEET_API + `/id/${item.id}`; await fetch(url, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ stok: `-= ${item.qty}` }) }); }
    }

    // floating
    function updateFloating(){ const cart = loadCart(); const cnt = cart.reduce((s,i)=>s+i.qty,0); document.getElementById('floatingCount').textContent = cnt; document.getElementById('floatingCart').style.display = cnt? 'inline-block' : 'none'; }

    // export csv (from current PRODUCTS state)
    document.getElementById('exportCsv').addEventListener('click',()=>{ const header = ['id','nama','harga','satuan','stok','gambar','kategori','deskripsi']; const rows = PRODUCTS.map(p=> header.map(h=> '"'+String(p[h]??p[(h==='nama'?'name':h)]??'')+'"').join(',')); const csv = [header.join(',')].concat(rows).join('
'); const blob = new Blob([csv],{type:'text/csv'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'yafa_products_export.csv'; a.click(); URL.revokeObjectURL(url); });

    // init & load products
    document.getElementById('q').addEventListener('input', ()=>{ // reset to full PRODUCTS before filtering search
      // to support search across full dataset, reload original dataset from remote or sample
      loadAllProducts().then(()=> applyFilters(true));
    });

    document.getElementById('loadMore').addEventListener('click', ()=> renderProductsChunk());

    async function loadAllProducts(){ setSkeleton('products',6); // fetch
      try{
        if(SHEET_API){ const res = await fetch(SHEET_API); const data = await res.json(); // normalize
          PRODUCTS = data.map(r=>({ id: r.id || r.ID || r.Id || r.row || '', name: r.nama || r.name || r.nama_produk || r.product_name || '', price: Number(r.harga||r.price||0), satuan: r.satuan||r.unit||'pcs', stok: Number(r.stok||r.stock||0), gambar: r.gambar||r.image||'', kategori: r.kategori||r.category||'Lainnya', deskripsi: r.deskripsi||r.desc||'' }));
        } else {
          PRODUCTS = JSON.parse(JSON.stringify(SAMPLE_PRODUCTS));
        }
        // restore stock state from localStorage (demo only)
        loadStockState();
        // reset display
        const container = document.getElementById('products'); container.innerHTML=''; displayOffset=0; renderCategories(); renderProductsChunk(); renderCart(); updateFloating();
      }catch(e){ console.error(e); PRODUCTS = JSON.parse(JSON.stringify(SAMPLE_PRODUCTS)); const container = document.getElementById('products'); container.innerHTML=''; displayOffset=0; renderCategories(); renderProductsChunk(); renderCart(); updateFloating(); }
    }

    // initial load
    loadAllProducts();

    // load local cart on start
    renderCart(); updateFloating();

  </script>
</body>
</html>
