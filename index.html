<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Yafa Mart â€” Neon Blue</title>
  <meta name="description" content="Yafa Mart - Katalog Online (COD via Telegram)" />
  <style>
    /* ---------------- theme ---------------- */
    :root{
      --bg:#071025;            /* deep midnight */
      --card:#071936;          /* card bg */
      --muted:#98a3b8;
      --accent:#00b0ff;        /* neon cyan */
      --accent-2:#6be0ff;
      --glass: rgba(255,255,255,0.04);
      --radius:16px;
      --glass-2: rgba(255,255,255,0.02);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg, #041022 0%, #061028 50%, #071025 100%);
      color: #e6f0ff;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding-bottom:80px;
    }

    /* ---------- header ---------- */
    .topbar{
      position:sticky; top:0; z-index:120;
      backdrop-filter: blur(6px);
      background: linear-gradient(180deg, rgba(7,25,38,0.65), rgba(7,25,38,0.45));
      border-bottom: 1px solid rgba(255,255,255,0.03);
      padding:10px 14px;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
    }
    .brand{display:flex;gap:12px;align-items:center;}
    .logo{
      width:44px;height:44px;border-radius:10px;
      background: linear-gradient(135deg,var(--accent),var(--accent-2));
      display:flex;align-items:center;justify-content:center;font-weight:800;color:#021124;font-size:18px;box-shadow:0 6px 18px rgba(3,132,255,0.12);
    }
    .brand .title{font-weight:700;font-size:16px;line-height:1}
    .brand .subtitle{font-size:12px;color:var(--muted);margin-top:2px}

    .header-actions{display:flex;gap:8px;align-items:center;}
    .searchbar{
      display:flex;align-items:center;gap:8px;background:var(--glass);padding:8px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);
      min-width:220px; max-width:520px; flex:1;
    }
    .searchbar input{
      background:transparent;border:0;color:inherit;outline:0;font-size:14px;width:100%;
    }
    .cat-select{
      background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted);padding:8px 10px;border-radius:10px;font-size:13px;
    }

    .icon-btn{
      background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.03);
      padding:8px 12px;border-radius:12px;color:var(--accent);cursor:pointer;font-weight:700;
      display:flex;align-items:center;gap:8px;
    }

    /* ---------- layout ---------- */
    .container{max-width:1100px;margin:14px auto;padding:0 14px;display:grid;grid-template-columns:1fr;gap:14px}
    /* product grid */
    .grid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:12px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:12px;padding:10px;border:1px solid rgba(0,178,255,0.06);box-shadow:0 6px 20px rgba(0,176,255,0.03);
      display:flex;flex-direction:column;gap:8px;cursor:pointer;transition:transform .12s ease,box-shadow .12s ease;
    }
    .card:hover{transform:translateY(-6px);box-shadow:0 16px 40px rgba(0,176,255,0.06)}
    .thumb{
      height:140px;border-radius:10px;background:linear-gradient(135deg,#022634,#043b4a);display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative;
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .card .title{font-weight:700;font-size:14px}
    .card .desc{font-size:12px;color:var(--muted);line-height:1.3;min-height:36px}
    .card .footer{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .price{font-weight:800;color:var(--accent);font-size:15px}
    .small{font-size:12px;color:var(--muted)}

    .add-btn{
      background:linear-gradient(90deg,var(--accent),var(--accent-2));
      color:#021124;border:none;padding:8px 10px;border-radius:8px;font-weight:700;cursor:pointer;
      box-shadow:0 6px 18px rgba(3,132,255,0.12)
    }

    /* ---------- cart floating ---------- */
    .cart-fab{
      position:fixed;right:18px;bottom:18px;z-index:140;display:flex;align-items:center;gap:10px;
    }
    .fab{
      background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#021124;padding:12px 14px;border-radius:999px;font-weight:800;box-shadow:0 20px 40px rgba(3,132,255,0.16);cursor:pointer;border:none;
    }
    .badge{background:#021124;color:var(--accent);padding:4px 8px;border-radius:999px;font-weight:800;border:1px solid rgba(255,255,255,0.06)}

    /* ---------- slide-up cart panel ---------- */
    .cart-panel{
      position:fixed;left:0;right:0;bottom:0;height:0;background:linear-gradient(180deg,#041022, #05182a);z-index:150;border-top-left-radius:18px;border-top-right-radius:18px;box-shadow:0 -10px 40px rgba(2,10,40,0.6);overflow:hidden;transition:height .28s ease;
    }
    .cart-panel.open{height:72vh;max-height:760px;border:1px solid rgba(0,178,255,0.06)}
    .cart-header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,0.02)}
    .cart-body{padding:12px 16px;overflow:auto;height:calc(72vh - 150px)}
    .cart-footer{padding:12px 16px;border-top:1px solid rgba(255,255,255,0.02);display:flex;flex-direction:column;gap:8px}

    .cart-item{display:flex;gap:10px;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.02)}
    .cart-item .ci-left{width:64px;height:64px;border-radius:8px;background:#012434;display:flex;align-items:center;justify-content:center}
    .cart-item .ci-info{flex:1}
    .cart-item .ci-remove{color:var(--muted);cursor:pointer;font-size:13px}

    .checkout-btn{
      background:linear-gradient(90deg,var(--accent),var(--accent-2));padding:12px;border-radius:12px;border:none;font-weight:800;color:#021124;cursor:pointer;
    }
    .ghost-btn{background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted);padding:8px;border-radius:10px;cursor:pointer}

    /* ---------- modal ---------- */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:160;display:none;align-items:center;justify-content:center;padding:20px}
    .modal-backdrop.show{display:flex}
    .modal{background:linear-gradient(180deg,#071a2a,#061226);border-radius:12px;padding:16px;width:100%;max-width:720px;border:1px solid rgba(0,178,255,0.06)}
    .modal .row{display:flex;gap:12px}
    .modal .col{flex:1}
    .input{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
    .label{font-size:13px;color:var(--muted);margin-bottom:6px}

    /* ---------- responsive ---------- */
    @media (max-width:900px){
      .grid{grid-template-columns:repeat(2,1fr)}
      .container{padding:10px}
      .searchbar{min-width:140px}
    }
    @media (max-width:520px){
      .grid{grid-template-columns:repeat(2,1fr);gap:10px}
      .thumb{height:120px}
    }
  </style>
</head>
<body>
  <!-- header -->
  <div class="topbar">
    <div class="brand">
      <div class="logo">YM</div>
      <div>
        <div class="title">Yafa Mart</div>
        <div class="subtitle">Katalog Online â€” COD via Telegram</div>
      </div>
    </div>

    <div style="display:flex;align-items:center;gap:10px;flex:1;margin-left:12px">
      <div class="searchbar" role="search" title="Cari produk">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="opacity:.9"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
        <input id="globalSearch" placeholder="Cari produk... contoh: beras, minyak" aria-label="Cari produk" />
        <select id="headerCategory" class="cat-select" aria-label="Filter kategori">
          <option value="">Semua</option>
        </select>
      </div>

      <div class="header-actions">
        <button id="openCartBtn" class="icon-btn" aria-label="Buka Keranjang">ðŸ›’ <span id="topCartCount">0</span></button>
      </div>
    </div>
  </div>

  <!-- main -->
  <div class="container">
    <section>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <div style="font-weight:800;font-size:18px">Daftar Produk</div>
        <div class="small" id="resultsInfo">Menampilkan 0</div>
      </div>

      <div id="productGrid" class="grid" aria-live="polite"></div>

      <div style="text-align:center;margin-top:14px">
        <button id="loadMore" class="ghost-btn">Muat lebih banyak</button>
      </div>
    </section>
  </div>

  <!-- cart floating -->
  <div class="cart-fab">
    <button id="fabOpen" class="fab" aria-label="Buka Keranjang">ðŸ›’ <span id="fabCount" style="margin-left:8px;font-weight:900">0</span></button>
  </div>

  <!-- slide-up cart panel -->
  <div id="cartPanel" class="cart-panel" aria-hidden="true">
    <div class="cart-header">
      <div style="display:flex;align-items:center;gap:10px">
        <div style="font-weight:800">Keranjang</div>
        <div class="small" id="cartSummarySmall">0 item</div>
      </div>
      <div>
        <button id="closeCart" class="ghost-btn">Tutup</button>
      </div>
    </div>

    <div class="cart-body">
      <div id="cartItemsList"></div>
      <div id="emptyCartNote" class="small" style="text-align:center;margin-top:18px;color:var(--muted)">Keranjang kosong</div>
    </div>

    <div class="cart-footer">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">Total: <span id="cartTotal">Rp 0</span></div>
        <div class="small" id="stockWarning" style="color:#ff9b9b;display:none">Beberapa item hampir habis</div>
      </div>
      <div style="display:flex;gap:8px">
        <button id="checkoutBtnNew" class="checkout-btn" style="flex:1">Checkout</button>
        <button id="clearCartBtn" class="ghost-btn">Kosongkan</button>
      </div>
    </div>
  </div>

  <!-- modal backdrop -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
    <div id="modal" class="modal" role="document" aria-labelledby="modalTitle">
      <!-- content injected dynamically -->
    </div>
  </div>

  <script>
    /********** CONFIG **********/
    const CLOUDFLARE_WORKER_URL = 'https://yafamart-telegram-api.baculum19.workers.dev'; // your worker
    const SHEET_API = 'https://sheetdb.io/api/v1/rcorje2n3osn1';
    const PAGE_SIZE = 20;
    const CART_KEY = 'yafa_cart_v2';
    const CUSTOMER_KEY = 'yafa_customer_v1';
    /*****************************/

    // state
    let ALL = [];
    let FILTERED = [];
    let offset = 0;
    let isFromSheet = false;

    // DOM
    const productGrid = document.getElementById('productGrid');
    const loadMoreBtn = document.getElementById('loadMore');
    const globalSearch = document.getElementById('globalSearch');
    const headerCategory = document.getElementById('headerCategory');
    const resultsInfo = document.getElementById('resultsInfo');

    const fabCount = document.getElementById('fabCount');
    const topCartCount = document.getElementById('topCartCount');
    const cartPanel = document.getElementById('cartPanel');
    const openCartBtn = document.getElementById('openCartBtn');
    const fabOpen = document.getElementById('fabOpen');
    const closeCart = document.getElementById('closeCart');
    const cartItemsList = document.getElementById('cartItemsList');
    const emptyCartNote = document.getElementById('emptyCartNote');
    const cartSummarySmall = document.getElementById('cartSummarySmall');
    const cartTotalEl = document.getElementById('cartTotal');
    const stockWarning = document.getElementById('stockWarning');
    const clearCartBtn = document.getElementById('clearCartBtn');
    const checkoutBtnNew = document.getElementById('checkoutBtnNew');

    const modalBackdrop = document.getElementById('modalBackdrop');
    const modal = document.getElementById('modal');

    /* ---------- helpers ---------- */
    function formatRp(n){
      return 'Rp ' + Number(n).toLocaleString('id-ID');
    }
    function loadCart(){ try{ return JSON.parse(localStorage.getItem(CART_KEY) || '[]'); }catch(e){ return []; } }
    function saveCart(c){ localStorage.setItem(CART_KEY, JSON.stringify(c)); renderCart(); updateFab(); }
    function loadCustomer(){ try{ return JSON.parse(localStorage.getItem(CUSTOMER_KEY) || 'null'); }catch(e){ return null; } }
    function saveCustomer(c){ localStorage.setItem(CUSTOMER_KEY, JSON.stringify(c)); }

    /* ---------- UI: products ---------- */
    function setSkeletonGrid(count=6){
      productGrid.innerHTML = '';
      for(let i=0;i<count;i++){
        const div = document.createElement('div'); div.className='card';
        div.innerHTML = '<div class="thumb skeleton" style="height:120px;background:linear-gradient(90deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01))"></div><div style="height:12px;width:60%;background:rgba(255,255,255,0.02);border-radius:6px"></div><div style="height:10px;width:40%;margin-top:8px;background:rgba(255,255,255,0.02);border-radius:6px"></div>';
        productGrid.appendChild(div);
      }
    }

    function renderChunk(){
      const chunk = FILTERED.slice(offset, offset + PAGE_SIZE);
      if(offset === 0) productGrid.innerHTML = '';
      if(chunk.length === 0 && offset === 0){
        productGrid.innerHTML = '<div style="grid-column:1/-1;color:var(--muted);text-align:center;padding:24px;background:transparent">Produk tidak ditemukan</div>';
        resultsInfo.textContent = 'Menampilkan 0';
        loadMoreBtn.style.display = 'none';
        return;
      }
      chunk.forEach(p => {
        const el = document.createElement('div'); el.className='card';
        const imgUrl = p.gambar && p.gambar.trim() ? p.gambar : '';
        const thumbHtml = imgUrl ? `<img src="${imgUrl}" alt="${escapeHtml(p.nama)}">` : '<div style="color:var(--muted);font-size:13px">Gambar tidak tersedia</div>';
        el.innerHTML = `<div class="thumb" data-id="${p.id}">${thumbHtml}</div>
                        <div class="title">${escapeHtml(p.nama)}</div>
                        <div class="desc">${escapeHtml(p.deskripsi || '')}</div>
                        <div class="footer">
                          <div>
                            <div class="price">${formatRp(p.harga)}</div>
                            <div class="small">per ${p.satuan || 'pcs'}</div>
                          </div>
                          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
                            <div class="small">${p.stok>0? 'Stok: '+p.stok : 'Habis'}</div>
                            <button class="add-btn" data-id="${p.id}">+ Keranjang</button>
                          </div>
                        </div>`;
        // click opens detail
        el.querySelector('.thumb').addEventListener('click', ()=> openProductModal(p.id));
        el.querySelector('.title').addEventListener('click', ()=> openProductModal(p.id));
        el.querySelector('.add-btn').addEventListener('click', (ev)=> {
          ev.stopPropagation();
          addToCart(p.id, 1);
        });
        productGrid.appendChild(el);
      });
      offset += chunk.length;
      resultsInfo.textContent = `Menampilkan ${Math.min(offset, FILTERED.length)} dari ${FILTERED.length}`;
      loadMoreBtn.style.display = offset >= FILTERED.length ? 'none' : 'inline-block';
    }

    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, (m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    /* ---------- categories ---------- */
    function renderCategories(){
      const set = Array.from(new Set(ALL.map(x=>x.kategori || 'Lainnya'))).sort();
      headerCategory.innerHTML = '<option value="">Semua</option>';
      set.forEach(c=>{
        const o = document.createElement('option');
        o.value = c; o.textContent = c;
        headerCategory.appendChild(o);
      });
    }

    /* ---------- filters ---------- */
    function applyFilters(){
      const q = globalSearch.value.trim().toLowerCase();
      const cat = headerCategory.value;
      FILTERED = ALL.filter(p=> {
        const inCat = !cat || (p.kategori === cat);
        const inText = !q || (p.nama || '').toLowerCase().includes(q) || (p.deskripsi||'').toLowerCase().includes(q) || (p.kategori||'').toLowerCase().includes(q);
        return inCat && inText;
      });
      offset = 0;
      productGrid.innerHTML = '';
      renderChunk();
    }

    globalSearch.addEventListener('input', debounce(()=> applyFilters(), 250));
    headerCategory.addEventListener('change', ()=> applyFilters());
    loadMoreBtn.addEventListener('click', ()=> renderChunk());

    /* ---------- cart ---------- */
    function updateFab(){
      const cart = loadCart();
      const cnt = cart.reduce((s,i)=>s+i.qty,0);
      fabCount.textContent = cnt;
      topCartCount.textContent = cnt;
      fabCount.parentElement && (fabCount.parentElement.dataset.count = cnt);
      document.getElementById('topCartCount').textContent = cnt;
    }

    function renderCart(){
      const cart = loadCart();
      cartItemsList.innerHTML = '';
      if(cart.length === 0){
        emptyCartNote.style.display = 'block';
      } else {
        emptyCartNote.style.display = 'none';
      }
      let total = 0;
      cart.forEach(i=>{
        const product = ALL.find(p=>p.id===i.id) || {};
        const row = document.createElement('div'); row.className='cart-item';
        row.innerHTML = `<div class="ci-left">${ (product.gambar? '<img src="'+product.gambar+'" style="width:100%;height:100%;object-fit:cover;border-radius:8px">' : '<div style="font-size:12px;color:var(--muted)">No image</div>') }</div>
                         <div class="ci-info"><div style="font-weight:700">${escapeHtml(i.name)}</div><div class="small">${i.qty} Ã— ${formatRp(i.price)}</div></div>
                         <div style="text-align:right"><div style="font-weight:700;color:var(--accent)">${formatRp(i.qty*i.price)}</div><div class="ci-remove" data-id="${i.id}">Hapus</div></div>`;
        cartItemsList.appendChild(row);
        total += i.qty*i.price;
      });
      cartSummarySmall.textContent = `${cart.length} item`;
      cartTotalEl.textContent = formatRp(total);
      document.getElementById('cartSummarySmall').textContent = `${cart.length} item`;
      // attach remove handlers
      cartItemsList.querySelectorAll('.ci-remove').forEach(btn => btn.addEventListener('click', ()=> {
        const id = btn.dataset.id;
        removeFromCart(id);
      }));
    }

    function addToCart(id, qty){
      const p = ALL.find(x=>x.id===id);
      if(!p) return alert('Produk tidak ditemukan');
      if(p.stok === 0) return alert('Produk habis');
      if(qty > p.stok) return alert('Stok tidak cukup. Stok tersedia: ' + p.stok);

      const cart = loadCart();
      const item = cart.find(x=>x.id===id);
      if(item){
        if(item.qty + qty > p.stok) return alert('Jumlah melebihi stok. Stok tersedia: ' + p.stok);
        item.qty += qty;
      } else {
        cart.push({ id:id, name:p.nama, price:p.harga, qty:qty });
      }
      saveCart(cart);
      flashAddButton(id);
    }

    function removeFromCart(id){
      const cart = loadCart().filter(i=>i.id !== id);
      saveCart(cart);
    }
    clearCartBtn.addEventListener('click', ()=> {
      if(confirm('Kosongkan keranjang?')) { saveCart([]); }
    });

    function flashAddButton(id){
      // small visual feedback
      const btn = document.querySelector(`button.add-btn[data-id="${id}"]`);
      if(!btn) return;
      const orig = btn.textContent;
      btn.textContent = 'âœ“ Ditambahkan';
      setTimeout(()=> btn.textContent = orig, 900);
    }

    // open/close cart panel
    function openCart(){ cartPanel.classList.add('open'); cartPanel.setAttribute('aria-hidden','false'); renderCart(); updateFab(); }
    function closeCartPanel(){ cartPanel.classList.remove('open'); cartPanel.setAttribute('aria-hidden','true'); }
    openCartBtn.addEventListener('click', openCart);
    fabOpen.addEventListener('click', openCart);
    closeCart.addEventListener('click', closeCartPanel);

    /* ---------- product modal ---------- */
    function openProductModal(id){
      const p = ALL.find(x=>x.id===id);
      if(!p) return;
      modal.innerHTML = `
        <div style="display:flex;gap:12px;flex-direction:column">
          <div style="display:flex;gap:12px;align-items:flex-start">
            <div style="flex:1">
              <div style="height:260px;border-radius:10px;overflow:hidden;background:#022b36;display:flex;align-items:center;justify-content:center">
                ${ p.gambar ? `<img src="${p.gambar}" style="width:100%;height:100%;object-fit:cover">` : '<div style="color:var(--muted)">Gambar tidak tersedia</div>' }
              </div>
            </div>
            <div style="width:320px;min-width:220px">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <h3 id="modalTitle" style="margin:0">${escapeHtml(p.nama)}</h3>
                <div class="small">${p.kategori || ''}</div>
              </div>
              <div style="margin-top:8px" class="small">${escapeHtml(p.deskripsi || '')}</div>
              <div style="margin-top:12px;font-weight:800;color:var(--accent)">${formatRp(p.harga)}</div>
              <div style="margin-top:8px" class="small">Stok: ${p.stok}</div>
              <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
                <input id="modalQty" type="number" min="1" max="${p.stok}" value="1" style="width:80px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit">
                <button id="modalAdd" class="add-btn">+ Keranjang</button>
              </div>
            </div>
          </div>
          <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:6px">
            <button id="modalClose" class="ghost-btn">Tutup</button>
          </div>
        </div>
      `;
      // handlers
      document.getElementById('modalAdd').addEventListener('click', ()=> {
        const qty = parseInt(document.getElementById('modalQty').value) || 1;
        addToCart(p.id, qty);
        closeModal();
      });
      document.getElementById('modalClose').addEventListener('click', closeModal);
      showModal();
    }

    function showModal(){ modalBackdrop.classList.add('show'); }
    function closeModal(){ modalBackdrop.classList.remove('show'); }

    modalBackdrop.addEventListener('click', (e)=> { if(e.target === modalBackdrop) closeModal(); });

    /* ---------- checkout ---------- */
    checkoutBtnNew.addEventListener('click', ()=> startCheckout());

    async function startCheckout(){
      const cart = loadCart();
      if(cart.length === 0) return alert('Keranjang kosong');

      let customer = loadCustomer();
      // if no stored customer -> show form modal
      if(!customer){
        await showCustomerForm();
        customer = loadCustomer();
        if(!customer) return; // user cancelled
      } else {
        // confirm use stored data
        const ok = confirm(`Gunakan data pengiriman tersimpan?\n\nNama: ${customer.name}\nNo HP: ${customer.phone}\nAlamat: ${customer.address}`);
        if(!ok){
          await showCustomerForm();
          customer = loadCustomer();
          if(!customer) return;
        }
      }

      // optional note
      let note = prompt('Catatan tambahan (opsional):', '') || '';

      // prepare payload
      const now = new Date();
      const tanggal = now.toLocaleDateString('id-ID', { day:'2-digit', month:'long', year:'numeric' });
      const waktu = now.toLocaleTimeString('id-ID', { hour:'2-digit', minute:'2-digit' });
      const total = cart.reduce((s,i)=>s + i.qty*i.price, 0);

      const payload = {
        customer: customer,
        cart: cart,
        date: tanggal,
        time: waktu,
        total: total,
        note: note
      };

      // disable checkout
      checkoutBtnNew.textContent = 'â³ Mengirim...'; checkoutBtnNew.disabled = true;

      try {
        const res = await fetch(CLOUDFLARE_WORKER_URL, {
          method: 'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });

        if(!res.ok){
          const text = await res.text();
          throw new Error('HTTP ' + res.status + ' - ' + text);
        }
        const data = await res.json();
        if(!data.success){
          throw new Error(data.message || 'Gagal mengirim pesanan');
        }

        // try update sheet stock if available
        if(isFromSheet && SHEET_API){
          try{ await updateStockInSheet(cart); }catch(e){ console.warn('Update stock failed', e); }
        }

        saveCart([]);
        alert('âœ… Pesanan berhasil dikirim. Terima kasih!');
        closeCartPanel();
      } catch(err){
        console.error(err);
        alert('âŒ Gagal kirim pesanan: ' + err.message + '\nSilakan hubungi admin.');
      } finally {
        checkoutBtnNew.textContent = 'Checkout'; checkoutBtnNew.disabled = false;
      }
    }

    /* ---------- customer form modal ---------- */
    function showCustomerForm(){
      return new Promise(resolve=>{
        modal.innerHTML = `
          <div style="display:flex;flex-direction:column;gap:8px">
            <h3 id="modalTitle">Data Pengiriman</h3>
            <div>
              <div class="label">Nama lengkap</div>
              <input id="cust_name" class="input" placeholder="Nama lengkap" />
            </div>
            <div>
              <div class="label">Nomor HP</div>
              <input id="cust_phone" class="input" placeholder="08123456789" />
            </div>
            <div>
              <div class="label">Alamat lengkap</div>
              <textarea id="cust_address" class="input" placeholder="Jalan, RT/RW, Kelurahan, Kecamatan, Kota" style="height:90px"></textarea>
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end">
              <button id="custCancel" class="ghost-btn">Batal</button>
              <button id="custSave" class="checkout-btn">Simpan & Lanjut</button>
            </div>
          </div>
        `;
        // prefill if exist
        const prev = loadCustomer();
        if(prev){ document.getElementById('cust_name').value = prev.name || ''; document.getElementById('cust_phone').value = prev.phone || ''; document.getElementById('cust_address').value = prev.address || ''; }

        showModal();
        document.getElementById('custCancel').addEventListener('click', ()=>{ closeModal(); resolve(false); });
        document.getElementById('custSave').addEventListener('click', ()=>{
          const name = document.getElementById('cust_name').value.trim();
          const phone = document.getElementById('cust_phone').value.trim();
          const address = document.getElementById('cust_address').value.trim();
          if(!name || !phone || !address){ alert('Semua data wajib diisi'); return; }
          saveCustomer({ name, phone, address });
          closeModal();
          resolve(true);
        });
      });
    }

    /* ---------- sheet update ---------- */
    async function updateStockInSheet(cart){
      for(const item of cart){
        const p = ALL.find(x=>x.id===item.id);
        if(!p) continue;
        const newStock = Math.max(0, p.stok - item.qty);
        const updateUrl = SHEET_API + '/id/' + item.id;
        const resp = await fetch(updateUrl, { method:'PATCH', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ stok:newStock })});
        if(!resp.ok) throw new Error('Update failed for ' + item.id);
        p.stok = newStock;
      }
    }

    /* ---------- load products ---------- */
    async function loadProducts(){
      setSkeletonGrid(8);
      try {
        const res = await fetch(SHEET_API);
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        if(!Array.isArray(data)) throw new Error('Data sheet invalid');
        ALL = data.map((r, idx)=>({
          id: String(r.id || r.ID || idx+1),
          nama: r.nama || r.name || 'Produk',
          harga: Number(r.harga || r.price || 0),
          satuan: r.satuan || r.unit || 'pcs',
          stok: Number(r.stok || r.stock || 0),
          gambar: r.gambar || r.image || r.img || '',
          kategori: r.kategori || r.category || 'Lainnya',
          deskripsi: r.deskripsi || r.desc || r.description || ''
        }));
        isFromSheet = true;
        FILTERED = [...ALL];
        offset = 0;
        renderCategories();
        renderChunk();
        updateFab();
      } catch(err){
        console.error('Load products error', err);
        ALL = []; FILTERED = []; offset = 0;
        productGrid.innerHTML = '<div style="grid-column:1/-1;color:var(--muted);text-align:center;padding:24px">Gagal memuat produk</div>';
      }
    }

    /* ---------- init ---------- */
    function init(){
      loadProducts();
      renderCart();
      updateFab();
      // wire events
      document.getElementById('fabOpen').addEventListener('click', openCart);
      document.getElementById('openCartBtn').addEventListener('click', openCart);
      document.getElementById('fabCount').textContent = loadCart().length;
    }

    /* ---------- utilities ---------- */
    function debounce(fn, wait=200){ let t; return function(){ clearTimeout(t); t=setTimeout(()=>fn.apply(this,arguments), wait); } }

    // expose remove via global (for console/debug)
    window.removeFromCart = removeFromCart;

    // run init
    init();

    // ensure cart rendering updates periodically
    setInterval(()=>{ renderCart(); updateFab(); }, 800);

  </script>
</body>
</html>
