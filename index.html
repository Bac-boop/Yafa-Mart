<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Yafa Mart</title>
  <style>
    :root{
      --primary:#5B9CE5;
      --primary-dark:#4A7FC4;
      --bg:#FAFBFC;
      --card:#FFFFFF;
      --text:#1A1A1A;
      --text-muted:#6B7280;
      --border:#E5E7EB;
      --shadow:0 2px 8px rgba(91,156,229,0.08);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      background:var(--bg);color:var(--text);padding-bottom:90px;
    }

    /* Header Sticky */
    .header{
      position:sticky;top:0;z-index:100;background:var(--card);
      box-shadow:0 2px 12px rgba(0,0,0,0.04);
    }
    .brand-section{
      text-align:center;padding:16px;border-bottom:1px solid var(--border);
    }
    .brand-title{font-size:24px;font-weight:700;color:var(--primary);letter-spacing:-0.5px}
    .brand-subtitle{font-size:13px;color:var(--text-muted);margin-top:4px}
    
    .toolbar{
      display:flex;align-items:center;gap:8px;padding:12px 14px;background:white;
    }
    .search-box{
      flex:1;display:flex;align-items:center;gap:8px;background:var(--bg);
      padding:10px 12px;border-radius:12px;border:1px solid var(--border);
      max-width:calc(100% - 180px);
    }
    .search-box input{
      flex:1;border:none;background:transparent;font-size:14px;outline:none;color:var(--text);
    }
    .search-box input::placeholder{color:var(--text-muted)}
    
    .filter-btn{
      display:flex;align-items:center;gap:4px;padding:10px 12px;
      background:white;border:1.5px solid var(--primary);border-radius:12px;
      color:var(--primary);font-weight:600;font-size:14px;cursor:pointer;
      flex-shrink:0;
    }
    .filter-btn.active{background:var(--primary);color:white}
    
    .cart-icon-btn{
      position:relative;padding:10px;background:var(--primary);
      border-radius:12px;color:white;cursor:pointer;border:none;
      flex-shrink:0;
    }
    .cart-badge{
      position:absolute;top:-6px;right:-6px;background:#FF4444;
      color:white;font-size:11px;font-weight:700;padding:2px 6px;
      border-radius:10px;min-width:20px;text-align:center;
    }

    /* Store Status Banner */
    .store-status-banner{
      background: var(--primary);
      color: white;
      padding: 10px 16px;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
    }

    /* Promo / Bundle Badges */
    .badge{
      position:absolute;
      top:10px;
      left:10px;
      background:#FF4444;
      color:white;
      padding:4px 8px;
      border-radius:6px;
      font-size:11px;
      font-weight:700;
      z-index:10;
    }
    .badge.bundle{
      background:#f59e0b;
    }

    /* Price strike + promo */
    .price-original{
      text-decoration: line-through;
      color: var(--text-muted);
      font-size: 12px;
    }
    .price-promo{
      color: #e11d48;
      font-weight: 700;
      font-size: 16px;
    }

    /* Filter Modal */
    .filter-modal{
      position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:200;
      display:none;align-items:flex-end;
    }
    .filter-modal.show{display:flex}
    .filter-content{
      background:white;width:100%;border-radius:20px 20px 0 0;
      padding:20px;max-height:70vh;overflow-y:auto;
    }
    .filter-header{
      display:flex;justify-content:space-between;align-items:center;
      margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border);
    }
    .filter-chips{display:flex;flex-wrap:wrap;gap:10px}
    .chip{
      padding:10px 18px;border-radius:20px;border:1.5px solid var(--border);
      background:white;color:var(--text);font-size:14px;cursor:pointer;
      transition:all 0.2s;
    }
    .chip.active{background:var(--primary);color:white;border-color:var(--primary)}
    .chip:active{transform:scale(0.95)}

    /* Products */
    .container{padding:14px}
    .products-header{
      display:flex;justify-content:space-between;align-items:center;
      margin-bottom:14px;
    }
    .products-title{font-size:18px;font-weight:700}
    .products-count{font-size:13px;color:var(--text-muted)}
    
    .products-grid{
      display:grid;grid-template-columns:repeat(2,1fr);gap:12px;
    }
    .product-card{
      background:white;border-radius:16px;overflow:hidden;
      box-shadow:var(--shadow);cursor:pointer;transition:transform 0.2s;
    }
    .product-card:active{transform:scale(0.98)}
    .product-image{
      width:100%;aspect-ratio:1;background:linear-gradient(135deg,#F0F4F8,#E8EFF7);
      display:flex;align-items:center;justify-content:center;overflow:hidden;
      position:relative;
    }
    .product-image img{width:100%;height:100%;object-fit:cover}
    .product-info{padding:12px}
    .product-name{font-size:14px;font-weight:600;margin-bottom:4px;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .product-desc{font-size:12px;color:var(--text-muted);margin-bottom:8px;
      display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;
      overflow:hidden;height:34px}
    .product-footer{display:flex;justify-content:space-between;align-items:center}
    .product-price{font-size:16px;font-weight:700;color:var(--primary)}
    .product-unit{font-size:11px;color:var(--text-muted)}
    .product-stock{font-size:12px;color:var(--text-muted)}
    .add-btn{
      padding:8px 16px;background:var(--primary);color:white;
      border:none;border-radius:10px;font-weight:600;font-size:13px;
      cursor:pointer;
    }
    .add-btn:active{background:var(--primary-dark)}

    .load-more{
      display:block;width:100%;padding:12px;margin-top:16px;
      background:white;border:1.5px solid var(--border);border-radius:12px;
      color:var(--text);font-weight:600;cursor:pointer;
    }

    /* Cart Floating */
    .cart-fab{
      position:fixed;bottom:20px;right:20px;z-index:90;
    }
    .fab{
      width:60px;height:60px;border-radius:50%;background:var(--primary);
      color:white;border:none;font-size:24px;box-shadow:0 4px 16px rgba(91,156,229,0.3);
      cursor:pointer;position:relative;
    }
    .fab .badge{
      position:absolute;top:-4px;right:-4px;background:#FF4444;
      color:white;font-size:12px;font-weight:700;padding:3px 7px;
      border-radius:10px;
    }

    /* Cart Panel */
    .cart-panel{
      position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:150;
      display:none;align-items:flex-end;
    }
    .cart-panel.show{display:flex}
    .cart-content{
      background:white;width:100%;border-radius:20px 20px 0 0;
      max-height:75vh;display:flex;flex-direction:column;
    }
    .cart-header{
      padding:16px;border-bottom:1px solid var(--border);
      display:flex;justify-content:space-between;align-items:center;
    }
    .cart-title{font-size:18px;font-weight:700}
    .cart-body{padding:16px;overflow-y:auto;flex:1}
    .cart-item{
      display:flex;gap:12px;padding:12px 0;border-bottom:1px solid var(--border);
    }
    .cart-item:last-child{border-bottom:none}
    .cart-item-img{
      width:70px;height:70px;border-radius:12px;
      background:linear-gradient(135deg,#F0F4F8,#E8EFF7);
      display:flex;align-items:center;justify-content:center;overflow:hidden;
    }
    .cart-item-img img{width:100%;height:100%;object-fit:cover}
    .cart-item-info{flex:1}
    .cart-item-name{font-size:14px;font-weight:600;margin-bottom:4px}
    .cart-item-detail{font-size:13px;color:var(--text-muted)}
    .cart-item-right{text-align:right}
    .cart-item-price{font-size:15px;font-weight:700;color:var(--primary);margin-bottom:6px}
    .cart-remove{font-size:12px;color:#FF4444;cursor:pointer}
    
    .cart-footer{padding:16px;border-top:1px solid var(--border)}
    .cart-total{
      display:flex;justify-content:space-between;align-items:center;
      margin-bottom:12px;
    }
    .cart-total-label{font-size:15px;font-weight:600}
    .cart-total-value{font-size:20px;font-weight:700;color:var(--primary)}
    .cart-actions{display:flex;gap:10px}
    .btn-checkout{
      flex:1;padding:14px;background:var(--primary);color:white;
      border:none;border-radius:12px;font-weight:700;font-size:15px;
      cursor:pointer;
    }
    .btn-clear{
      padding:14px 20px;background:white;color:var(--text);
      border:1.5px solid var(--border);border-radius:12px;font-weight:600;
      cursor:pointer;
    }

    /* Modal */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:200;
      display:none;align-items:center;justify-content:center;padding:20px;
    }
    .modal-backdrop.show{display:flex}
    .modal{
      background:white;border-radius:20px;width:100%;max-width:500px;
      max-height:90vh;overflow-y:auto;
    }
    .modal-header{
      padding:20px;border-bottom:1px solid var(--border);
      display:flex;justify-content:space-between;align-items:center;
    }
    .modal-title{font-size:20px;font-weight:700}
    .modal-close{
      width:32px;height:32px;border-radius:50%;border:none;
      background:var(--bg);color:var(--text);font-size:20px;
      cursor:pointer;
    }
    .modal-body{padding:20px}
    .modal-image{
      width:100%;aspect-ratio:1;border-radius:16px;overflow:hidden;
      background:linear-gradient(135deg,#F0F4F8,#E8EFF7);
      display:flex;align-items:center;justify-content:center;
      margin-bottom:16px;
      position:relative;
    }
    .modal-image img{width:100%;height:100%;object-fit:cover}
    .modal-product-name{font-size:20px;font-weight:700;margin-bottom:8px}
    .modal-product-desc{font-size:14px;color:var(--text-muted);line-height:1.5;margin-bottom:16px}
    .modal-price-row{
      display:flex;justify-content:space-between;align-items:center;
      padding:12px 0;border-top:1px solid var(--border);
      border-bottom:1px solid var(--border);margin-bottom:16px;
    }
    .modal-price{font-size:24px;font-weight:700;color:var(--primary)}
    .modal-stock{font-size:14px;color:var(--text-muted)}
    .modal-add-section{display:flex;gap:10px;align-items:center}
    .qty-input{
      width:80px;padding:10px;border:1.5px solid var(--border);
      border-radius:10px;font-size:15px;text-align:center;
    }
    .btn-add-cart{
      flex:1;padding:12px;background:var(--primary);color:white;
      border:none;border-radius:12px;font-weight:700;cursor:pointer;
    }

    .form-group{margin-bottom:16px}
    .form-label{display:block;margin-bottom:6px;font-size:14px;font-weight:600}
    .form-input{
      width:100%;padding:12px;border:1.5px solid var(--border);
      border-radius:10px;font-size:14px;
    }
    .form-input:focus{outline:none;border-color:var(--primary)}
    
    .skeleton{
      background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);
      background-size:200% 100%;animation:shimmer 1.5s infinite;
    }
    @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

    @media (min-width:768px){
      .products-grid{grid-template-columns:repeat(3,1fr)}
    }
    @media (min-width:1024px){
      .products-grid{grid-template-columns:repeat(4,1fr)}
      .container{max-width:1200px;margin:0 auto}
    }
  </style>
</head>
<body>
  
  <!-- Header Sticky -->
  <div class="header">
    <div class="brand-section">
      <div class="brand-title">Yafa Mart</div>
      <div class="brand-subtitle">Belanja mudah via Telegram</div>
    </div>
    <div class="toolbar">
      <div class="search-box">
        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
        </svg>
        <input id="searchInput" placeholder="Cari produk...">
      </div>
      <button class="filter-btn" id="filterBtn">
        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M3 4h18M7 8h10M10 12h4"/>
        </svg>
        Filter
      </button>
      <button class="cart-icon-btn" id="headerCartBtn">
        <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-1.4 5M17 13l1.4 5M9 21a1 1 0 100-2 1 1 0 000 2zM18 21a1 1 0 100-2 1 1 0 000 2z"/>
        </svg>
        <span class="cart-badge" id="headerCartCount">0</span>
      </button>
    </div>
  </div>

  <!-- Store Status Banner -->
  <div id="storeStatusBanner" class="store-status-banner">
    <span id="storeStatusText">Memuat status...</span>
  </div>

  <!-- Filter Modal -->
  <div class="filter-modal" id="filterModal">
    <div class="filter-content">
      <div class="filter-header">
        <div style="font-size:18px;font-weight:700">Pilih Kategori</div>
        <button class="modal-close" id="closeFilter">Ã—</button>
      </div>
      <div class="filter-chips" id="filterChips"></div>
    </div>
  </div>

  <!-- Products -->
  <div class="container">
    <div class="products-header">
      <div class="products-title">Daftar Produk</div>
      <div class="products-count" id="productsCount">0 produk</div>
    </div>
    <div class="products-grid" id="productsGrid"></div>
    <button class="load-more" id="loadMoreBtn" style="display:none">Muat Lebih Banyak</button>
  </div>

  <!-- Cart FAB -->
  <div class="cart-fab">
    <button class="fab" id="fabCartBtn">
      ðŸ›’
      <span class="badge" id="fabCartCount">0</span>
    </button>
  </div>

  <!-- Cart Panel -->
  <div class="cart-panel" id="cartPanel">
    <div class="cart-content">
      <div class="cart-header">
        <div class="cart-title">Keranjang Belanja</div>
        <button class="modal-close" id="closeCartBtn">Ã—</button>
      </div>
      <div class="cart-body" id="cartBody">
        <div style="text-align:center;color:var(--text-muted);padding:40px 20px">
          Keranjang kosong
        </div>
      </div>
      <div class="cart-footer">
        <div class="cart-total">
          <div class="cart-total-label">Total</div>
          <div class="cart-total-value" id="cartTotal">Rp 0</div>
        </div>
        <div class="cart-actions">
          <button class="btn-checkout" id="checkoutBtn">Checkout</button>
          <button class="btn-clear" id="clearCartBtn">Kosongkan</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Product Detail Modal -->
  <div class="modal-backdrop" id="productModal">
    <div class="modal" id="productModalContent"></div>
  </div>

  <!-- Customer Form Modal -->
  <div class="modal-backdrop" id="customerModal">
    <div class="modal" id="customerModalContent"></div>
  </div>

  <script>
    const CLOUDFLARE_WORKER_URL = 'https:' + '//yafamart-telegram-api.baculum19.workers.dev';
    const SHEET_API = 'https:' + '//sheetdb.io/api/v1/rcorje2n3osn1';
    const PAGE_SIZE = 20;
    const CART_KEY = 'yafa_cart_v2';
    const PROFILE_KEY = 'yafa_profile_v1';

    let ALL_PRODUCTS = [];
    let FILTERED_PRODUCTS = [];
    let displayOffset = 0;
    let selectedCategory = '';

    function formatRp(n){ return 'Rp ' + Number(n).toLocaleString('id-ID'); }
    function loadCart(){ try{ return JSON.parse(localStorage.getItem(CART_KEY) || '[]'); }catch(e){ return []; } }
    function saveCart(c){ localStorage.setItem(CART_KEY, JSON.stringify(c)); renderCart(); updateCartBadges(); }
    function loadProfile(){ try{ return JSON.parse(localStorage.getItem(PROFILE_KEY) || 'null'); }catch(e){ return null; } }
    function saveProfile(p){ localStorage.setItem(PROFILE_KEY, JSON.stringify(p)); }

    function setSkeleton(){
      const grid = document.getElementById('productsGrid');
      grid.innerHTML = '';
      for(let i=0;i<6;i++){
        const card = document.createElement('div');
        card.className = 'product-card';
        card.innerHTML = '<div class="product-image skeleton" style="aspect-ratio:1"></div><div class="product-info"><div class="skeleton" style="height:14px;width:80%;margin-bottom:8px;border-radius:4px"></div><div class="skeleton" style="height:12px;width:60%;border-radius:4px"></div></div>';
        grid.appendChild(card);
      }
    }

    function renderCategories(){
      const cats = ['Semua', ...Array.from(new Set(ALL_PRODUCTS.map(p=>p.kategori||'Lainnya'))).sort()];
      const chips = document.getElementById('filterChips');
      chips.innerHTML = '';
      cats.forEach(c=>{
        const chip = document.createElement('div');
        chip.className = 'chip' + (c === 'Semua' && !selectedCategory ? ' active' : (c === selectedCategory ? ' active' : ''));
        chip.textContent = c;
        chip.addEventListener('click', ()=>{
          selectedCategory = c === 'Semua' ? '' : c;
          applyFilters();
          document.getElementById('filterModal').classList.remove('show');
          renderCategories();
        });
        chips.appendChild(chip);
      });
    }

    function applyFilters(){
      const q = document.getElementById('searchInput').value.trim().toLowerCase();
      FILTERED_PRODUCTS = ALL_PRODUCTS.filter(p=>{
        const matchCat = !selectedCategory || p.kategori === selectedCategory;
        const matchQ = !q || p.nama.toLowerCase().includes(q) || (p.deskripsi||'').toLowerCase().includes(q);
        return matchCat && matchQ;
      });
      displayOffset = 0;
      document.getElementById('productsGrid').innerHTML = '';
      renderChunk();
    }

    function renderChunk(){
      const grid = document.getElementById('productsGrid');
      const chunk = FILTERED_PRODUCTS.slice(displayOffset, displayOffset + PAGE_SIZE);
      if(chunk.length === 0 && displayOffset === 0){
        grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-muted)">Produk tidak ditemukan</div>';
      }
      chunk.forEach(p=>{
        const card = document.createElement('div');
        card.className = 'product-card';
        const imgHtml = p.gambar ? `<img src="${p.gambar}" alt="${p.nama}">` : '<div style="color:var(--text-muted);font-size:12px">No Image</div>';
        
        const priceHtml = p.harga_promo && p.harga_promo !== ""
          ? `<div class="price-original">${formatRp(p.harga)}</div><div class="price-promo">${formatRp(p.harga_promo)}</div>`
          : `<div class="product-price">${formatRp(p.harga)}</div>`;

        card.innerHTML = `
          <div class="product-image">
            ${p.promo ? '<div class="badge">Promo</div>' : ''}
            ${p.bundle ? '<div class="badge bundle">Bundle</div>' : ''}
            ${imgHtml}
          </div>
          <div class="product-info">
            <div class="product-name">${p.nama}</div>
            <div class="product-desc">${p.deskripsi||''}</div>
            <div class="product-footer">
              <div>
                ${priceHtml}
                <div class="product-unit">${p.satuan||'pcs'}</div>
              </div>
              <div style="text-align:right">
                <div class="product-stock">Stok: ${p.stok}</div>
                <button class="add-btn" data-id="${p.id}">+ Keranjang</button>
              </div>
            </div>
          </div>
        `;
        card.querySelector('.product-image').addEventListener('click', ()=>openProductModal(p.id));
        card.querySelector('.product-name').addEventListener('click', ()=>openProductModal(p.id));
        card.querySelector('.add-btn').addEventListener('click', (e)=>{
          e.stopPropagation();
          addToCart(p.id, 1);
        });
        grid.appendChild(card);
      });
      displayOffset += chunk.length;
      document.getElementById('productsCount').textContent = `${Math.min(displayOffset,FILTERED_PRODUCTS.length)} dari ${FILTERED_PRODUCTS.length} produk`;
      document.getElementById('loadMoreBtn').style.display = displayOffset >= FILTERED_PRODUCTS.length ? 'none' : 'block';
    }

    function addToCart(id, qty){
      const p = ALL_PRODUCTS.find(x=>x.id===id);
      if(!p) return alert('Produk tidak ditemukan');
      if(p.stok === 0) return alert('Stok habis');
      if(qty > p.stok) return alert('Stok tidak cukup');
      const cart = loadCart();
      const item = cart.find(x=>x.id===id);
      const finalPrice = p.harga_promo && p.harga_promo !== "" ? p.harga_promo : p.harga;
      if(item){
        if(item.qty + qty > p.stok) return alert('Jumlah melebihi stok');
        item.qty += qty;
      } else {
        cart.push({id, name:p.nama, price:finalPrice, qty, unit:p.satuan||'pcs'});
      }
      saveCart(cart);
    }

    function renderCart(){
      const cart = loadCart();
      const body = document.getElementById('cartBody');
      if(cart.length === 0){
        body.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:40px 20px">Keranjang kosong</div>';
        document.getElementById('cartTotal').textContent = 'Rp 0';
        return;
      }
      body.innerHTML = '';
      let total = 0;
      cart.forEach(i=>{
        const p = ALL_PRODUCTS.find(x=>x.id===i.id)||{};
        const item = document.createElement('div');
        item.className = 'cart-item';
        const imgHtml = p.gambar ? `<img src="${p.gambar}" alt="${i.name}">` : '<div style="font-size:12px;color:var(--text-muted)">No Image</div>';
        item.innerHTML = `
          <div class="cart-item-img">${imgHtml}</div>
          <div class="cart-item-info">
            <div class="cart-item-name">${i.name}</div>
            <div class="cart-item-detail">${i.qty} Ã— ${formatRp(i.price)}</div>
          </div>
          <div class="cart-item-right">
            <div class="cart-item-price">${formatRp(i.qty*i.price)}</div>
            <div class="cart-remove" data-id="${i.id}">Hapus</div>
          </div>
        `;
        item.querySelector('.cart-remove').addEventListener('click', ()=>{
          const cart = loadCart().filter(x=>x.id!==i.id);
          saveCart(cart);
        });
        body.appendChild(item);
        total += i.qty*i.price;
      });
      document.getElementById('cartTotal').textContent = formatRp(total);
    }

    function updateCartBadges(){
      const cart = loadCart();
      const count = cart.reduce((s,i)=>s+i.qty,0);
      document.getElementById('headerCartCount').textContent = count;
      document.getElementById('fabCartCount').textContent = count;
      document.getElementById('headerCartCount').style.display = count > 0 ? 'block' : 'none';
      document.getElementById('fabCartCount').style.display = count > 0 ? 'inline-block' : 'none';
    }

    function openProductModal(id){
      const p = ALL_PRODUCTS.find(x=>x.id===id);
      if(!p) return;
      const modal = document.getElementById('productModalContent');
      const imgHtml = p.gambar ? `<img src="${p.gambar}" alt="${p.nama}">` : '<div style="font-size:14px;color:var(--text-muted)">Gambar tidak tersedia</div>';
      
      const priceModalHtml = p.harga_promo && p.harga_promo !== ""
        ? `<div class="price-original" style="font-size:14px">${formatRp(p.harga)}</div><div class="price-promo" style="font-size:24px">${formatRp(p.harga_pr
