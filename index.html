<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Yafa Mart</title>
  <style>
    :root{
      --primary:#5B9CE5;
      --primary-dark:#4A7FC4;
      --bg:#FAFBFC;
      --card:#FFFFFF;
      --text:#1A1A1A;
      --text-muted:#6B7280;
      --border:#E5E7EB;
      --shadow:0 2px 8px rgba(91,156,229,0.08);
      --promo-red:#e11d48;
      --bundle-orange:#f59e0b;
      --success-green:#10b981;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      background:var(--bg);color:var(--text);padding-bottom:90px;
    }

    .header{
      position:sticky;top:0;z-index:100;background:var(--card);
      box-shadow:0 2px 12px rgba(0,0,0,0.04);
    }
    .brand-section{
      text-align:center;padding:16px;border-bottom:1px solid var(--border);
      cursor:pointer;
    }
    .brand-section:active{background:var(--bg)}
    .brand-title{font-size:24px;font-weight:700;color:var(--primary);letter-spacing:-0.5px}
    .brand-subtitle{font-size:13px;color:var(--text-muted);margin-top:4px}
    
    .toolbar{
      display:flex;align-items:center;gap:6px;padding:10px 12px;background:white;
    }
    .search-box{
      flex:1;display:flex;align-items:center;gap:6px;background:var(--bg);
      padding:8px 10px;border-radius:10px;border:1px solid var(--border);
      min-width:0;
    }
    .search-box svg{
      flex-shrink:0;
    }
    .search-box input{
      flex:1;border:none;background:transparent;font-size:13px;outline:none;color:var(--text);
      min-width:0;
    }
    .search-box input::placeholder{color:var(--text-muted)}
    
    .filter-btn{
      display:flex;align-items:center;gap:3px;padding:8px 10px;
      background:white;border:1.5px solid var(--primary);border-radius:10px;
      color:var(--primary);font-weight:600;font-size:13px;cursor:pointer;
      flex-shrink:0;
      white-space:nowrap;
    }
    .filter-btn svg{
      flex-shrink:0;
    }
    .filter-btn.active{background:var(--primary);color:white}
    
    .cart-header-btn{
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:8px 10px;
      background:var(--primary);
      border-radius:10px;
      color:white;
      cursor:pointer;
      border:none;
      flex-shrink:0;
      font-size:13px;
      font-weight:600;
      white-space:nowrap;
    }
    .cart-header-btn:active{background:var(--primary-dark)}
    .cart-header-badge{
      position:absolute;
      top:-6px;
      right:-6px;
      background:#FF4444;
      color:white;
      font-size:10px;
      font-weight:700;
      padding:2px 5px;
      border-radius:10px;
      min-width:18px;
      text-align:center;
    }

    .store-status-banner{
      padding:12px 16px;
      text-align:center;
      font-size:14px;
      font-weight:600;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .store-status-banner.open{background:var(--success-green);color:white}
    .store-status-banner.closed{background:#ef4444;color:white}
    .store-status-banner.loading{background:#6b7280;color:white}

    .badge{
      position:absolute;
      top:8px;
      left:8px;
      color:white;
      padding:4px 8px;
      border-radius:6px;
      font-size:11px;
      font-weight:700;
      z-index:10;
      box-shadow:0 2px 4px rgba(0,0,0,0.2);
    }
    .badge.promo{background:var(--promo-red)}
    .badge.bundle{background:var(--bundle-orange)}

    .price-wrapper{display:flex;flex-direction:column;gap:2px}
    .price-original{
      text-decoration:line-through;
      color:var(--text-muted);
      font-size:12px;
    }
    .price-promo{
      color:var(--promo-red);
      font-weight:700;
      font-size:16px;
    }
    .price-normal{
      font-size:16px;
      font-weight:700;
      color:var(--primary);
    }

    .filter-modal{
      position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:200;
      display:none;align-items:flex-end;
    }
    .filter-modal.show{display:flex}
    .filter-content{
      background:white;width:100%;border-radius:20px 20px 0 0;
      padding:20px;max-height:70vh;overflow-y:auto;
    }
    .filter-header{
      display:flex;justify-content:space-between;align-items:center;
      margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border);
    }
    .filter-chips{display:flex;flex-wrap:wrap;gap:10px}
    .chip{
      padding:10px 18px;border-radius:20px;border:1.5px solid var(--border);
      background:white;color:var(--text);font-size:14px;cursor:pointer;
      transition:all 0.2s;
    }
    .chip.active{background:var(--primary);color:white;border-color:var(--primary)}
    .chip:active{transform:scale(0.95)}

    .container{padding:14px}
    .products-header{
      display:flex;justify-content:space-between;align-items:center;
      margin-bottom:14px;
    }
    .products-title{font-size:18px;font-weight:700}
    .products-count{font-size:13px;color:var(--text-muted)}
    
    .products-grid{
      display:grid;grid-template-columns:repeat(2,1fr);gap:12px;
    }
    .product-card{
      background:white;border-radius:16px;overflow:hidden;
      box-shadow:var(--shadow);cursor:pointer;transition:transform 0.2s;
    }
    .product-card:active{transform:scale(0.98)}
    .product-image{
      width:100%;aspect-ratio:1;background:linear-gradient(135deg,#F0F4F8,#E8EFF7);
      display:flex;align-items:center;justify-content:center;overflow:hidden;
      position:relative;
    }
    .product-image img{width:100%;height:100%;object-fit:cover}
    .product-info{padding:12px}
    .product-name{font-size:14px;font-weight:600;margin-bottom:4px;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .product-desc{font-size:12px;color:var(--text-muted);margin-bottom:8px;
      display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;
      overflow:hidden;height:34px}
    .product-footer{display:flex;justify-content:space-between;align-items:center}
    .product-price{font-size:16px;font-weight:700;color:var(--primary)}
    .product-unit{font-size:11px;color:var(--text-muted);margin-top:2px}
    .product-stock{font-size:12px;color:var(--text-muted)}
    .add-btn{
      padding:8px 16px;background:var(--primary);color:white;
      border:none;border-radius:10px;font-weight:600;font-size:13px;
      cursor:pointer;
    }
    .add-btn:active{background:var(--primary-dark)}

    .bundle-items{
      font-size:11px;
      color:var(--text-muted);
      margin-bottom:8px;
      line-height:1.4;
    }

    .load-more{
      display:block;width:100%;padding:12px;margin-top:16px;
      background:white;border:1.5px solid var(--border);border-radius:12px;
      color:var(--text);font-weight:600;cursor:pointer;
    }

    .cart-fab{
      position:fixed;bottom:20px;right:20px;z-index:90;
    }
    .fab{
      width:60px;height:60px;border-radius:50%;background:var(--primary);
      color:white;border:none;font-size:24px;box-shadow:0 4px 16px rgba(91,156,229,0.3);
      cursor:pointer;position:relative;
    }
    .fab .badge{
      position:absolute;top:-4px;right:-4px;background:#FF4444;
      color:white;font-size:12px;font-weight:700;padding:3px 7px;
      border-radius:10px;
    }

    .cart-panel{
      position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:150;
      display:none;align-items:flex-end;
    }
    .cart-panel.show{display:flex}
    .cart-content{
      background:white;width:100%;border-radius:20px 20px 0 0;
      max-height:75vh;display:flex;flex-direction:column;
    }
    .cart-header{
      padding:16px;border-bottom:1px solid var(--border);
      display:flex;justify-content:space-between;align-items:center;
    }
    .cart-title{font-size:18px;font-weight:700}
    .cart-body{padding:16px;overflow-y:auto;flex:1}
    .cart-item{
      display:flex;gap:12px;padding:12px 0;border-bottom:1px solid var(--border);
    }
    .cart-item:last-child{border-bottom:none}
    .cart-item-img{
      width:70px;height:70px;border-radius:12px;
      background:linear-gradient(135deg,#F0F4F8,#E8EFF7);
      display:flex;align-items:center;justify-content:center;overflow:hidden;
    }
    .cart-item-img img{width:100%;height:100%;object-fit:cover}
    .cart-item-info{flex:1}
    .cart-item-name{font-size:14px;font-weight:600;margin-bottom:4px}
    .cart-item-detail{font-size:13px;color:var(--text-muted)}
    .cart-item-right{text-align:right}
    .cart-item-price{font-size:15px;font-weight:700;color:var(--primary);margin-bottom:6px}
    .cart-remove{font-size:12px;color:#FF4444;cursor:pointer}
    
    .cart-footer{padding:16px;border-top:1px solid var(--border)}
    .cart-total{
      display:flex;justify-content:space-between;align-items:center;
      margin-bottom:12px;
    }
    .cart-total-label{font-size:15px;font-weight:600}
    .cart-total-value{font-size:20px;font-weight:700;color:var(--primary)}
    .cart-actions{display:flex;gap:10px}
    .btn-checkout{
      flex:1;padding:14px;background:var(--success-green);color:white;
      border:none;border-radius:12px;font-weight:700;font-size:15px;
      cursor:pointer;
    }
    .btn-checkout:active{background:#059669}
    .btn-clear{
      padding:14px 20px;background:white;color:var(--text);
      border:1.5px solid var(--border);border-radius:12px;font-weight:600;
      cursor:pointer;
    }

    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:200;
      display:none;align-items:center;justify-content:center;padding:20px;
    }
    .modal-backdrop.show{display:flex}
    .modal{
      background:white;border-radius:20px;width:100%;max-width:500px;
      max-height:90vh;overflow-y:auto;
    }
    .modal-header{
      padding:20px;border-bottom:1px solid var(--border);
      display:flex;justify-content:space-between;align-items:center;
    }
    .modal-title{font-size:20px;font-weight:700}
    .modal-close{
      width:32px;height:32px;border-radius:50%;border:none;
      background:var(--bg);color:var(--text);font-size:20px;
      cursor:pointer;
    }
    .modal-body{padding:20px}
    .modal-image{
      width:100%;aspect-ratio:1;border-radius:16px;overflow:hidden;
      background:linear-gradient(135deg,#F0F4F8,#E8EFF7);
      display:flex;align-items:center;justify-content:center;
      margin-bottom:16px;
      position:relative;
    }
    .modal-image img{width:100%;height:100%;object-fit:cover}
    .modal-product-name{font-size:20px;font-weight:700;margin-bottom:8px}
    .modal-product-desc{font-size:14px;color:var(--text-muted);line-height:1.5;margin-bottom:16px}
    .modal-price-row{
      padding:12px 0;border-top:1px solid var(--border);
      border-bottom:1px solid var(--border);margin-bottom:16px;
    }
    .modal-price-wrapper{display:flex;justify-content:space-between;align-items:flex-start}
    .modal-price{font-size:24px;font-weight:700;color:var(--primary)}
    .modal-price-original{
      text-decoration:line-through;
      color:var(--text-muted);
      font-size:16px;
      margin-bottom:4px;
    }
    .modal-price-promo{
      color:var(--promo-red);
      font-size:28px;
      font-weight:700;
    }
    .modal-stock{font-size:14px;color:var(--text-muted)}
    .modal-promo-info{
      font-size:13px;
      color:var(--promo-red);
      margin-top:8px;
      font-weight:600;
    }
    .modal-add-section{display:flex;gap:10px;align-items:center}
    .qty-input{
      width:80px;padding:10px;border:1.5px solid var(--border);
      border-radius:10px;font-size:15px;text-align:center;
    }
    .btn-add-cart{
      flex:1;padding:12px;background:var(--primary);color:white;
      border:none;border-radius:12px;font-weight:700;cursor:pointer;
    }

    .form-group{margin-bottom:16px}
    .form-label{display:block;margin-bottom:6px;font-size:14px;font-weight:600}
    .form-input{
      width:100%;padding:12px;border:1.5px solid var(--border);
      border-radius:10px;font-size:14px;
    }
    .form-input:focus{outline:none;border-color:var(--primary)}
    .form-hint{font-size:12px;color:var(--text-muted);margin-top:4px}
    
    .skeleton{
      background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);
      background-size:200% 100%;animation:shimmer 1.5s infinite;
    }
    @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

    @media (min-width:768px){
      .products-grid{grid-template-columns:repeat(3,1fr)}
    }
    @media (min-width:1024px){
      .products-grid{grid-template-columns:repeat(4,1fr)}
      .container{max-width:1200px;margin:0 auto}
    }
  </style>
</head>
<body>
  
  <div class="header">
    <div class="brand-section" id="brandSection">
      <div class="brand-title">Yafa Mart</div>
      <div class="brand-subtitle">Belanja mudah tanpa keluar rumah</div>
    </div>
    <div class="toolbar">
      <div class="search-box">
        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
        </svg>
        <input id="searchInput" placeholder="Cari produk...">
      </div>
      <button class="filter-btn" id="filterBtn">
        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M3 4h18M7 8h10M10 12h4"/>
        </svg>
        Filter
      </button>
      <button class="cart-header-btn" id="headerCartBtn">
        Pesanan
        <span class="cart-header-badge" id="headerCartBadge">0</span>
      </button>
    </div>
  </div>

  <div id="storeStatusBanner" class="store-status-banner loading">
    <span id="storeStatusText">Memuat status toko...</span>
  </div>

  <div class="filter-modal" id="filterModal">
    <div class="filter-content">
      <div class="filter-header">
        <div style="font-size:18px;font-weight:700">Pilih Kategori</div>
        <button class="modal-close" id="closeFilter">√ó</button>
      </div>
      <div class="filter-chips" id="filterChips"></div>
    </div>
  </div>

  <div class="container">
    <div class="products-header">
      <div class="products-title">Daftar Produk</div>
      <div class="products-count" id="productsCount">0 produk</div>
    </div>
    <div class="products-grid" id="productsGrid"></div>
    <button class="load-more" id="loadMoreBtn" style="display:none">Muat Lebih Banyak</button>
  </div>

  <div class="cart-fab">
    <button class="fab" id="fabCartBtn">
      üõí
      <span class="badge" id="fabCartCount">0</span>
    </button>
  </div>

  <div class="cart-panel" id="cartPanel">
    <div class="cart-content">
      <div class="cart-header">
        <div class="cart-title">Keranjang Belanja</div>
        <button class="modal-close" id="closeCartBtn">√ó</button>
      </div>
      <div class="cart-body" id="cartBody">
        <div style="text-align:center;color:var(--text-muted);padding:40px 20px">
          Keranjang kosong
        </div>
      </div>
      <div class="cart-footer">
        <div class="cart-total">
          <div class="cart-total-label">Total</div>
          <div class="cart-total-value" id="cartTotal">Rp 0</div>
        </div>
        <div class="cart-actions">
          <button class="btn-checkout" id="checkoutBtn">üõçÔ∏è Pesan Sekarang</button>
          <button class="btn-clear" id="clearCartBtn">Kosongkan</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="productModal">
    <div class="modal" id="productModalContent"></div>
  </div>

  <div class="modal-backdrop" id="customerModal">
    <div class="modal" id="customerModalContent"></div>
  </div>

  <script>
    const CLOUDFLARE_WORKER_URL = 'https://yafamart-telegram-api.baculum19.workers.dev';
    const SHEET_API = 'https://yafamart-sheet-api.baculum19.workers.dev;
    const PAGE_SIZE = 20;
    const CART_KEY = 'yafa_cart_v2';
    const PROFILE_KEY = 'yafa_profile_v2';

    let ALL_PRODUCTS = [];
    let ALL_BUNDLES = [];
    let FILTERED_PRODUCTS = [];
    let displayOffset = 0;
    let selectedCategory = '';

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    
    function formatRp(num){
      return 'Rp ' + Number(num).toLocaleString('id-ID');
    }

    // Parse multiple images from comma-separated string
    function parseImages(imageStr){
      if(!imageStr) return [];
      
      const urls = String(imageStr).split(',').map(url => url.trim()).filter(Boolean);
      
      return urls.map(url => {
        if(url.includes('drive.google.com/file/d/')){
          const match = url.match(/\/file\/d\/([^\/]+)/);
          if(match){
            return `https://drive.google.com/uc?export=view&id=${match[1]}`;
          }
        }
        return url;
      });
    }

    // Create Image Carousel HTML
    function createImageCarousel(images, altText){
      if(!images || images.length === 0){
        return '<div style="color:var(--text-muted);font-size:12px">No Image</div>';
      }
      
      if(images.length === 1){
        return `<img src="${images[0]}" alt="${altText}" style="width:100%;height:100%;object-fit:cover">`;
      }
      
      let html = '<div class="image-carousel" style="width:100%;height:100%;position:relative;overflow:hidden">';
      html += '<div class="carousel-track" style="display:flex;transition:transform 0.3s ease;height:100%">';
      
      images.forEach((img, idx) => {
        html += `<div class="carousel-slide" style="min-width:100%;height:100%;flex-shrink:0"><img src="${img}" alt="${altText}" style="width:100%;height:100%;object-fit:cover"></div>`;
      });
      
      html += '</div>';
      
      if(images.length > 1){
        html += '<button class="carousel-prev" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.5);color:white;border:none;border-radius:50%;width:36px;height:36px;font-size:20px;cursor:pointer;z-index:10">‚Äπ</button>';
        html += '<button class="carousel-next" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.5);color:white;border:none;border-radius:50%;width:36px;height:36px;font-size:20px;cursor:pointer;z-index:10">‚Ä∫</button>';
        
        html += '<div class="carousel-dots" style="position:absolute;bottom:10px;left:50%;transform:translateX(-50%);display:flex;gap:8px;z-index:10">';
        for(let i = 0; i < images.length; i++){
          html += `<div class="carousel-dot ${i === 0 ? 'active' : ''}" style="width:8px;height:8px;border-radius:50%;background:${i === 0 ? 'white' : 'rgba(255,255,255,0.5)'};cursor:pointer"></div>`;
        }
        html += '</div>';
      }
      
      html += '</div>';
      return html;
    }

    // Initialize Carousel Interactions
    function initCarousel(container){
      const carousel = container.querySelector('.image-carousel');
      if(!carousel) return;
      
      const track = carousel.querySelector('.carousel-track');
      const slides = carousel.querySelectorAll('.carousel-slide');
      const prevBtn = carousel.querySelector('.carousel-prev');
      const nextBtn = carousel.querySelector('.carousel-next');
      const dots = carousel.querySelectorAll('.carousel-dot');
      
      let currentIndex = 0;
      const totalSlides = slides.length;
      
      function updateCarousel(){
        track.style.transform = `translateX(-${currentIndex * 100}%)`;
        dots.forEach((dot, idx) => {
          dot.classList.toggle('active', idx === currentIndex);
          dot.style.background = idx === currentIndex ? 'white' : 'rgba(255,255,255,0.5)';
        });
      }
      
      function goToSlide(index){
        currentIndex = Math.max(0, Math.min(index, totalSlides - 1));
        updateCarousel();
      }
      
      if(prevBtn){
        prevBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          goToSlide(currentIndex - 1);
        });
      }
      
      if(nextBtn){
        nextBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          goToSlide(currentIndex + 1);
        });
      }
      
      dots.forEach((dot, idx) => {
        dot.addEventListener('click', (e) => {
          e.stopPropagation();
          goToSlide(idx);
        });
      });
      
      let startX = 0;
      let currentX = 0;
      let isDragging = false;
      
      carousel.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        isDragging = true;
      });
      
      carousel.addEventListener('touchmove', (e) => {
        if(!isDragging) return;
        currentX = e.touches[0].clientX;
      });
      
      carousel.addEventListener('touchend', () => {
        if(!isDragging) return;
        const diff = startX - currentX;
        if(Math.abs(diff) > 50){
          if(diff > 0){
            goToSlide(currentIndex + 1);
          } else {
            goToSlide(currentIndex - 1);
          }
        }
        isDragging = false;
      });
      
      carousel.addEventListener('mousedown', (e) => {
        startX = e.clientX;
        isDragging = true;
        carousel.style.cursor = 'grabbing';
      });
      
      carousel.addEventListener('mousemove', (e) => {
        if(!isDragging) return;
        currentX = e.clientX;
      });
      
      carousel.addEventListener('mouseup', () => {
        if(!isDragging) return;
        const diff = startX - currentX;
        if(Math.abs(diff) > 50){
          if(diff > 0){
            goToSlide(currentIndex + 1);
          } else {
            goToSlide(currentIndex - 1);
          }
        }
        isDragging = false;
        carousel.style.cursor = 'grab';
      });
      
      carousel.addEventListener('mouseleave', () => {
        isDragging = false;
        carousel.style.cursor = 'grab';
      });
    }

    function loadCart(){ 
      try{ 
        return JSON.parse(localStorage.getItem(CART_KEY) || '[]'); 
      }catch(e){ 
        return []; 
      } 
    }

    function saveCart(c){ 
      localStorage.setItem(CART_KEY, JSON.stringify(c)); 
      renderCart(); 
      updateCartBadges(); 
    }

    function loadProfile(){ 
      try{ 
        return JSON.parse(localStorage.getItem(PROFILE_KEY) || 'null'); 
      }catch(e){ 
        return null; 
      } 
    }

    function saveProfile(p){ 
      localStorage.setItem(PROFILE_KEY, JSON.stringify(p)); 
    }

    function parseDate(dateStr){
      if(!dateStr) return null;
      
      dateStr = String(dateStr).trim();
      if(dateStr === '') return null;
      
      if(dateStr.match(/^\d{4}-\d{1,2}-\d{1,2}$/)){
        const [year, month, day] = dateStr.split('-').map(x => parseInt(x));
        return new Date(year, month - 1, day);
      }
      
      if(dateStr.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)){
        const parts = dateStr.split('/');
        const month = parseInt(parts[0]);
        const day = parseInt(parts[1]);
        const year = parseInt(parts[2]);
        return new Date(year, month - 1, day);
      }
      
      const date = new Date(dateStr);
      return isNaN(date.getTime()) ? null : date;
    }

    function isPromoActive(product){
      if(!product.aktif_diskon || product.aktif_diskon.toString().toUpperCase() !== 'TRUE') return false;
      if(!product.harga_diskon || product.harga_diskon <= 0) return false;
      if(!product.promo_mulai || !product.promo_selesai) return false;
      
      const now = new Date();
      now.setHours(0,0,0,0);
      const start = parseDate(product.promo_mulai);
      const end = parseDate(product.promo_selesai);
      
      if(!start || !end) return false;
      start.setHours(0,0,0,0);
      end.setHours(23,59,59,999);
      
      return now >= start && now <= end;
    }

    function isBundlePromoActive(bundle){
      if(!bundle.bundle_promo_mulai || !bundle.bundle_promo_selesai) return false;
      
      const now = new Date();
      now.setHours(0,0,0,0);
      const start = parseDate(bundle.bundle_promo_mulai);
      const end = parseDate(bundle.bundle_promo_selesai);
      
      if(!start || !end) return false;
      start.setHours(0,0,0,0);
      end.setHours(23,59,59,999);
      
      return now >= start && now <= end;
    }

    function getDiscountPercent(harga, harga_diskon){
      return Math.round(((harga - harga_diskon) / harga) * 100);
    }

    function sortProducts(products){
      const promoProducts = [];
      const promoBundles = [];
      const normalBundles = [];
      const normalProducts = [];
      
      products.forEach(p=>{
        if(p.isBundle){
          if(isBundlePromoActive(p)){
            const percent = p.harga_bundle_original ? getDiscountPercent(p.harga_bundle_original, p.harga_bundle) : 0;
            promoBundles.push({...p, discountPercent: percent});
          } else {
            normalBundles.push(p);
          }
        } else {
          if(isPromoActive(p)){
            const percent = getDiscountPercent(p.harga, p.harga_diskon);
            promoProducts.push({...p, discountPercent: percent});
          } else {
            normalProducts.push(p);
          }
        }
      });
      
      promoProducts.sort((a,b) => b.discountPercent - a.discountPercent);
      promoBundles.sort((a,b) => b.discountPercent - a.discountPercent);
      
      return [...promoProducts, ...promoBundles, ...normalBundles, ...normalProducts];
    }

    function setSkeleton(){
      const grid = document.getElementById('productsGrid');
      grid.innerHTML = '';
      for(let i=0;i<6;i++){
        const card = document.createElement('div');
        card.className = 'product-card';
        card.innerHTML = '<div class="product-image skeleton" style="aspect-ratio:1"></div><div class="product-info"><div class="skeleton" style="height:14px;width:80%;margin-bottom:8px;border-radius:4px"></div><div class="skeleton" style="height:12px;width:60%;border-radius:4px"></div></div>';
        grid.appendChild(card);
      }
    }

    function renderCategories(){
      const cats = ['Semua', ...Array.from(new Set(ALL_PRODUCTS.map(p=>p.kategori||'Lainnya'))).sort()];
      const chips = document.getElementById('filterChips');
      chips.innerHTML = '';
      cats.forEach(c=>{
        const chip = document.createElement('div');
        chip.className = 'chip' + (c === 'Semua' && !selectedCategory ? ' active' : (c === selectedCategory ? ' active' : ''));
        chip.textContent = c;
        chip.addEventListener('click', ()=>{
          selectedCategory = c === 'Semua' ? '' : c;
          applyFilters();
          document.getElementById('filterModal').classList.remove('show');
          renderCategories();
        });
        chips.appendChild(chip);
      });
    }

    function applyFilters(){
      const q = document.getElementById('searchInput').value.trim().toLowerCase();
      const allItems = [...ALL_PRODUCTS, ...ALL_BUNDLES];
      
      let filtered = allItems.filter(p=>{
        const matchCat = !selectedCategory || p.kategori === selectedCategory;
        const matchQ = !q || p.nama.toLowerCase().includes(q) || (p.deskripsi||'').toLowerCase().includes(q);
        return matchCat && matchQ;
      });
      
      FILTERED_PRODUCTS = sortProducts(filtered);
      displayOffset = 0;
      document.getElementById('productsGrid').innerHTML = '';
      renderChunk();
    }

    function renderChunk(){
      const grid = document.getElementById('productsGrid');
      const chunk = FILTERED_PRODUCTS.slice(displayOffset, displayOffset + PAGE_SIZE);
      if(chunk.length === 0 && displayOffset === 0){
        grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-muted)">Produk tidak ditemukan</div>';
      }
      chunk.forEach(p=>{
        const card = document.createElement('div');
        card.className = 'product-card';
        
        const images = parseImages(p.gambar);
        const firstImage = images.length > 0 ? images[0] : '';
        const imgHtml = firstImage ? `<img src="${firstImage}" alt="${p.nama}">` : '<div style="color:var(--text-muted);font-size:12px">No Image</div>';
        
        let badgeHtml = '';
        let priceHtml = '';
        
        if(p.isBundle){
          const bundlePromoActive = isBundlePromoActive(p);
          if(bundlePromoActive && p.harga_bundle_original){
            const percent = getDiscountPercent(p.harga_bundle_original, p.harga_bundle);
            badgeHtml = `<div class="badge promo">-${percent}%</div>`;
            priceHtml = `<div class="price-wrapper"><div class="price-original">${formatRp(p.harga_bundle_original)}</div><div class="price-promo">${formatRp(p.harga_bundle)}</div></div>`;
          } else {
            badgeHtml = '<div class="badge bundle">PAKET</div>';
            priceHtml = `<div class="price-normal">${formatRp(p.harga_bundle)}</div>`;
          }
        } else {
          const promoActive = isPromoActive(p);
          if(promoActive){
            const percent = getDiscountPercent(p.harga, p.harga_diskon);
            badgeHtml = `<div class="badge promo">-${percent}%</div>`;
            priceHtml = `<div class="price-wrapper"><div class="price-original">${formatRp(p.harga)}</div><div class="price-promo">${formatRp(p.harga_diskon)}</div></div>`;
          } else {
            priceHtml = `<div class="price-normal">${formatRp(p.harga)}</div>`;
          }
        }

        const bundleItemsHtml = p.isBundle && p.bundleItems ? `<div class="bundle-items">Isi: ${p.bundleItems}</div>` : '';
        const multiImageIndicator = images.length > 1 ? `<div style="position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,0.6);color:white;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600">üì∑ ${images.length}</div>` : '';

        card.innerHTML = `
          <div class="product-image">
            ${badgeHtml}
            ${imgHtml}
            ${multiImageIndicator}
          </div>
          <div class="product-info">
            <div class="product-name">${p.nama}</div>
            ${bundleItemsHtml}
            <div class="product-desc">${p.deskripsi||''}</div>
            <div class="product-footer">
              <div>
                ${priceHtml}
                <div class="product-unit">${p.satuan||'paket'}</div>
              </div>
              <div style="text-align:right">
                ${!p.isBundle ? `<div class="product-stock">Stok: ${p.stok}</div>` : ''}
                <button class="add-btn" data-id="${p.id}" data-bundle="${p.isBundle||false}">+ Keranjang</button>
              </div>
            </div>
          </div>
        `;
        card.querySelector('.product-image').addEventListener('click', ()=>openProductModal(p.id, p.isBundle));
        card.querySelector('.product-name').addEventListener('click', ()=>openProductModal(p.id, p.isBundle));
        card.querySelector('.add-btn').addEventListener('click', (e)=>{
          e.stopPropagation();
          addToCart(p.id, 1, p.isBundle);
        });
        grid.appendChild(card);
      });
      displayOffset += chunk.length;
      document.getElementById('productsCount').textContent = `${Math.min(displayOffset,FILTERED_PRODUCTS.length)} dari ${FILTERED_PRODUCTS.length} produk`;
      document.getElementById('loadMoreBtn').style.display = displayOffset >= FILTERED_PRODUCTS.length ? 'none' : 'block';
    }

    function addToCart(id, qty, isBundle){
      const item = isBundle ? ALL_BUNDLES.find(x=>x.id===id) : ALL_PRODUCTS.find(x=>x.id===id);
      if(!item) return alert('Produk tidak ditemukan');
      
      if(!isBundle){
        if(item.stok === 0) return alert('Stok habis');
        if(qty > item.stok) return alert('Stok tidak cukup');
      }
      
      const cart = loadCart();
      const cartItem = cart.find(x=>x.id===id && x.isBundle===isBundle);
      
      let finalPrice;
      if(isBundle){
        finalPrice = item.harga_bundle;
      } else {
        const promoActive = isPromoActive(item);
        finalPrice = promoActive ? item.harga_diskon : item.harga;
      }
      
      if(cartItem){
        if(!isBundle && cartItem.qty + qty > item.stok) return alert('Jumlah melebihi stok');
        cartItem.qty += qty;
      } else {
        const images = parseImages(item.gambar);
        cart.push({
          id,
          name: item.nama,
          price: finalPrice,
          qty,
          unit: item.satuan || 'paket',
          isBundle: isBundle || false,
          image: images.length > 0 ? images[0] : ''
        });
      }
      saveCart(cart);
    }

    function renderCart(){
      const cart = loadCart();
      const body = document.getElementById('cartBody');
      if(cart.length === 0){
        body.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:40px 20px">Keranjang kosong</div>';
        document.getElementById('cartTotal').textContent = 'Rp 0';
        return;
      }
      body.innerHTML = '';
      let total = 0;
      cart.forEach(i=>{
        const item = document.createElement('div');
        item.className = 'cart-item';
        const imgHtml = i.image ? `<img src="${i.image}" alt="${i.name}">` : '<div style="font-size:12px;color:var(--text-muted)">No Image</div>';
        item.innerHTML = `
          <div class="cart-item-img">${imgHtml}</div>
          <div class="cart-item-info">
            <div class="cart-item-name">${i.name}${i.isBundle ? ' <span style="font-size:11px;color:#f59e0b">(Paket)</span>' : ''}</div>
            <div class="cart-item-detail">${i.qty} √ó ${formatRp(i.price)}</div>
          </div>
          <div class="cart-item-right">
            <div class="cart-item-price">${formatRp(i.qty*i.price)}</div>
            <div class="cart-remove" data-id="${i.id}" data-bundle="${i.isBundle}">Hapus</div>
          </div>
        `;
        item.querySelector('.cart-remove').addEventListener('click', ()=>{
          const cart = loadCart().filter(x=>!(x.id===i.id && x.isBundle===i.isBundle));
          saveCart(cart);
        });
        body.appendChild(item);
        total += i.qty*i.price;
      });
      document.getElementById('cartTotal').textContent = formatRp(total);
    }

    function updateCartBadges(){
      const cart = loadCart();
      const count = cart.reduce((s,i)=>s+i.qty,0);
      const headerBadge = document.getElementById('headerCartBadge');
      const fabBadge = document.getElementById('fabCartCount');
      
      headerBadge.textContent = count;
      fabBadge.textContent = count;
      
      headerBadge.style.display = count > 0 ? 'block' : 'none';
      fabBadge.style.display = count > 0 ? 'inline-block' : 'none';
    }

    function openProductModal(id, isBundle){
      const item = isBundle ? ALL_BUNDLES.find(x=>x.id===id) : ALL_PRODUCTS.find(x=>x.id===id);
      if(!item) return;
      const modal = document.getElementById('productModalContent');
      
      const images = parseImages(item.gambar);
      const carouselHtml = createImageCarousel(images, item.nama);
      
      let badgeHtml = '';
      let priceHtml = '';
      let promoInfoHtml = '';
      let stockHtml = '';
      let qtyInputHtml = '';
      
      if(isBundle){
        const bundlePromoActive = item.bundle_promo_mulai && item.bundle_promo_selesai && isBundlePromoActive(item);
        if(bundlePromoActive && item.harga_bundle_original){
          const percent = getDiscountPercent(item.harga_bundle_original, item.harga_bundle);
          badgeHtml = `<div class="badge promo">-${percent}%</div>`;
          priceHtml = `<div><div class="modal-price-original">${formatRp(item.harga_bundle_original)}</div><div class="modal-price-promo">${formatRp(item.harga_bundle)}</div></div>`;
          
          const endDate = parseDate(item.bundle_promo_selesai);
          if(endDate){
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            promoInfoHtml = `<div class="modal-promo-info">‚è∞ Promo sampai: ${endDate.toLocaleDateString('id-ID', options)}</div>`;
          }
        } else {
          badgeHtml = '<div class="badge bundle">PAKET</div>';
          priceHtml = `<div class="modal-price">${formatRp(item.harga_bundle)}</div>`;
        }
        stockHtml = item.bundle_stok ? `<div class="modal-stock">Stok: ${item.bundle_stok}</div>` : '';
        qtyInputHtml = `<input type="number" class="qty-input" id="modalQty" min="1" ${item.bundle_stok ? `max="${item.bundle_stok}"` : ''} value="1">`;
      } else {
        const promoActive = isPromoActive(item);
        if(promoActive){
          const percent = getDiscountPercent(item.harga, item.harga_diskon);
          badgeHtml = `<div class="badge promo">-${percent}%</div>`;
          priceHtml = `<div><div class="modal-price-original">${formatRp(item.harga)}</div><div class="modal-price-promo">${formatRp(item.harga_diskon)}</div></div>`;
          
          const endDate = parseDate(item.promo_selesai);
          if(endDate){
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            promoInfoHtml = `<div class="modal-promo-info">‚è∞ Promo sampai: ${endDate.toLocaleDateString('id-ID', options)}</div>`;
          }
        } else {
          priceHtml = `<div class="modal-price">${formatRp(item.harga)}</div>`;
        }
        stockHtml = `<div class="modal-stock">Stok: ${item.stok}</div>`;
        qtyInputHtml = `<input type="number" class="qty-input" id="modalQty" min="1" max="${item.stok}" value="1">`;
      }

      const bundleItemsHtml = isBundle && item.bundleItems ? `<div style="background:#fef3c7;padding:12px;border-radius:8px;margin-bottom:16px"><strong>Isi Paket:</strong><br>${item.bundleItems}</div>` : '';

      modal.innerHTML = `
        <div class="modal-header">
          <div class="modal-title">Detail ${isBundle ? 'Paket' : 'Produk'}</div>
          <button class="modal-close" id="closeProductModal">√ó</button>
        </div>
        <div class="modal-body">
          <div class="modal-image">
            ${badgeHtml}
            ${carouselHtml}
          </div>
          <div class="modal-product-name">${item.nama}</div>
          ${bundleItemsHtml}
          <div class="modal-product-desc">${item.deskripsi||'-'}</div>
          <div class="modal-price-row">
            <div class="modal-price-wrapper">
              ${priceHtml}
              ${stockHtml}
            </div>
          </div>
          ${promoInfoHtml}
          <div class="modal-add-section">
            ${qtyInputHtml}
            <button class="btn-add-cart" id="modalAddBtn">Tambah ke Keranjang</button>
          </div>
        </div>
      `;
      
      setTimeout(() => {
        const carouselContainer = modal.querySelector('.modal-image');
        if(carouselContainer){
          initCarousel(carouselContainer);
        }
      }, 100);
      
      document.getElementById('closeProductModal').addEventListener('click', ()=>closeModal('productModal'));
      document.getElementById('modalAddBtn').addEventListener('click', ()=>{
        const qty = parseInt(document.getElementById('modalQty').value)||1;
        addToCart(item.id, qty, isBundle);
        closeModal('productModal');
      });
      document.getElementById('productModal').classList.add('show');
    }

    function closeModal(id){
      document.getElementById(id).classList.remove('show');
    }

    function resetToHome(){
      selectedCategory = '';
      document.getElementById('searchInput').value = '';
      applyFilters();
      renderCategories();
      window.scrollTo({top: 0, behavior: 'smooth'});
    }

    async function doCheckout(){
      const cart = loadCart();
      if(cart.length === 0) return alert('Keranjang kosong');
      
      let profile = loadProfile();
      if(!profile){
        const ok = await showCustomerForm();
        if(!ok) return;
        profile = loadProfile();
      } else {
        const addressPreview = `${profile.street}\nRT/RW: ${profile.rtRw}\nKelurahan: ${profile.kelurahan}\nKecamatan: ${profile.kecamatan}\nKota: ${profile.kota}`;
        const use = confirm(`Gunakan data:\nNama: ${profile.name}\nHP: ${profile.phone}\n\nAlamat:\n${addressPreview}`);
        if(!use){
          const ok = await showCustomerForm();
          if(!ok) return;
          profile = loadProfile();
        }
      }
      
      const note = prompt('Catatan (opsional):') || '';
      const now = new Date();
      
      let addressText = `${profile.street}\nRT/RW: ${profile.rtRw}\nKelurahan: ${profile.kelurahan}\nKecamatan: ${profile.kecamatan}\nKota: ${profile.kota}`;
      
      let gpsLink = '';
      if(profile.gps && profile.gps.lat && profile.gps.lng){
        gpsLink = `https://maps.google.com/?q=${profile.gps.lat},${profile.gps.lng}`;
      }
      
      const btn = document.getElementById('checkoutBtn');
      btn.textContent = '‚è≥ Memproses...';
      btn.disabled = true;

      try{
        const stockResult = await updateStockAPI(cart);
        if(!stockResult.success){
          throw new Error(stockResult.message || 'Stok tidak cukup');
        }
        
        const payload = {
          customer: {
            name: profile.name,
            phone: profile.phone,
            address: addressText,
            gpsLink: gpsLink
          },
          cart,
          date: now.toLocaleDateString('id-ID', {day:'2-digit',month:'long',year:'numeric'}),
          time: now.toLocaleTimeString('id-ID', {hour:'2-digit',minute:'2-digit'}),
          total: cart.reduce((s,i)=>s+i.qty*i.price,0),
          note
        };
        
        btn.textContent = '‚è≥ Mengirim pesanan...';
        const res = await fetch(CLOUDFLARE_WORKER_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        if(!data.success) throw new Error(data.message||'Gagal mengirim pesanan');
        
        saveCart([]);
        alert('‚úÖ Pesanan berhasil dikirim!\nTerima kasih sudah berbelanja.');
        closeModal('cartPanel');
        
        setTimeout(() => {
          loadProducts();
        }, 1000);
        
      }catch(err){
        console.error(err);
        alert('‚ùå Gagal: ' + err.message);
      }finally{
        btn.textContent = 'üõçÔ∏è Pesan Sekarang';
        btn.disabled = false;
      }
    }
    
    async function updateStockAPI(cart) {
  try {
    const updates = cart.map(item => ({
      row_id: item.id,         // harus row_id
      fields: { stok: item.sisaStok } // harus fields:{}
    }));

    const response = await fetch(`${SHEET_API}/update_stok`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ updates })
    });

    return await response.json();
  } catch (err) {
    console.error("updateStockAPI error:", err);
    return { error: true };
  }
}



    function showCustomerForm(){
      return new Promise(resolve=>{
        const modal = document.getElementById('customerModalContent');
        const prev = loadProfile();
        let gpsCoords = null;
        
        modal.innerHTML = `
          <div class="modal-header">
            <div class="modal-title">Data Pengiriman</div>
            <button class="modal-close" id="closeCustomerModal">√ó</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label class="form-label">Nama Lengkap</label>
              <input type="text" class="form-input" id="custName" value="${prev?.name||''}" placeholder="Nama lengkap">
            </div>
            <div class="form-group">
              <label class="form-label">Nomor HP/WhatsApp</label>
              <input type="tel" class="form-input" id="custPhone" value="${prev?.phone||''}" placeholder="0850xxxxxxxx">
              <div class="form-hint">10-13 digit</div>
            </div>
            <div class="form-group">
              <label class="form-label">Jalan</label>
              <input type="text" class="form-input" id="custStreet" value="${prev?.street||''}" placeholder="Jl. Merdeka No. 123">
            </div>
            <div class="form-group">
              <label class="form-label">RT/RW</label>
              <input type="text" class="form-input" id="custRtRw" value="${prev?.rtRw||''}" placeholder="001/002 atau 1/2">
            </div>
            <div class="form-group">
              <label class="form-label">Kelurahan</label>
              <input type="text" class="form-input" id="custKelurahan" value="${prev?.kelurahan||''}" placeholder="Kelurahan">
            </div>
            <div class="form-group">
              <label class="form-label">Kecamatan</label>
              <input type="text" class="form-input" id="custKecamatan" value="${prev?.kecamatan||''}" placeholder="Kecamatan">
            </div>
            <div class="form-group">
              <label class="form-label">Kota/Kabupaten</label>
              <input type="text" class="form-input" id="custKota" value="${prev?.kota||''}" placeholder="Jakarta Selatan">
            </div>
            <div class="form-group">
              <button id="btnGetLocation" style="width:100%;padding:12px;background:var(--primary);color:white;border:none;border-radius:10px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px">
                <span>üìç</span>
                <span>Tandai Lokasi Saya</span>
              </button>
              <div id="gpsStatus" style="font-size:12px;color:var(--text-muted);margin-top:8px;text-align:center">Belum ada lokasi GPS</div>
            </div>
            <div style="display:flex;gap:10px">
              <button class="btn-clear" id="custCancel" style="flex:1">Batal</button>
              <button class="btn-checkout" id="custSave" style="flex:1">Simpan & Lanjut</button>
            </div>
          </div>
        `;
        
        document.getElementById('closeCustomerModal').addEventListener('click', ()=>{
          closeModal('customerModal');
          resolve(false);
        });
        
        document.getElementById('custCancel').addEventListener('click', ()=>{
          closeModal('customerModal');
          resolve(false);
        });
        
        document.getElementById('btnGetLocation').addEventListener('click', ()=>{
          const btn = document.getElementById('btnGetLocation');
          const status = document.getElementById('gpsStatus');
          
          btn.disabled = true;
          btn.innerHTML = '<span>‚è≥</span><span>Mendapatkan lokasi...</span>';
          status.textContent = 'Meminta akses lokasi...';
          status.style.color = 'var(--text-muted)';
          
          if(!navigator.geolocation){
            btn.disabled = false;
            btn.innerHTML = '<span>üìç</span><span>Tandai Lokasi Saya</span>';
            status.textContent = '‚ö†Ô∏è GPS tidak tersedia, lanjutkan dengan alamat manual';
            status.style.color = '#f59e0b';
            return;
          }
          
          navigator.geolocation.getCurrentPosition(
            (position)=>{
              gpsCoords = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
              };
              btn.disabled = false;
              btn.innerHTML = '<span>‚úÖ</span><span>Lokasi Berhasil Ditandai</span>';
              btn.style.background = 'var(--success-green)';
              status.textContent = `‚úÖ Lokasi: ${gpsCoords.lat.toFixed(6)}, ${gpsCoords.lng.toFixed(6)}`;
              status.style.color = 'var(--success-green)';
            },
            (error)=>{
              btn.disabled = false;
              btn.innerHTML = '<span>üìç</span><span>Tandai Lokasi Saya</span>';
              status.textContent = '‚ö†Ô∏è GPS tidak tersedia, lanjutkan dengan alamat manual';
              status.style.color = '#f59e0b';
            },
            {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 0
            }
          );
        });
        
        document.getElementById('custSave').addEventListener('click', ()=>{
          const name = document.getElementById('custName').value.trim();
          const phone = document.getElementById('custPhone').value.trim();
          const street = document.getElementById('custStreet').value.trim();
          const rtRw = document.getElementById('custRtRw').value.trim();
          const kelurahan = document.getElementById('custKelurahan').value.trim();
          const kecamatan = document.getElementById('custKecamatan').value.trim();
          const kota = document.getElementById('custKota').value.trim();
          
          if(!name||!phone||!street||!rtRw||!kelurahan||!kecamatan||!kota){
            return alert('Semua data wajib diisi');
          }
          
          const phoneDigits = phone.replace(/\D/g, '');
          if(phoneDigits.length < 10 || phoneDigits.length > 13){
            return alert('Nomor HP harus 10-13 digit');
          }
          
          const profile = {
            name,
            phone,
            street,
            rtRw,
            kelurahan,
            kecamatan,
            kota,
            gps: gpsCoords
          };
          
          saveProfile(profile);
          closeModal('customerModal');
          resolve(true);
        });
        
        document.getElementById('customerModal').classList.add('show');
      });
    }

  async function fetchSheet(name) {
  try {
    const map = {
      produk: "produk",
      bundle: "bundle",
      status: "status"
    };

    if (!map[name]) return [];

    const res = await fetch(`${SHEET_API}/${map[name]}`);
    if (!res.ok) return [];

    const data = await res.json();
    return data?.results || [];   
  } catch (e) {
    console.error("fetchSheet error", e);
    return [];
  }
}


   async function loadAllData() {
  try {
    const [produk, bundle, status] = await Promise.all([
      fetchSheet("produk"),
      fetchSheet("bundle"),
      fetchSheet("status")
    ]);

    return {
      produk: produk || [],
      bundle: bundle || [],
      status: status && status.length > 0 ? status[0] : null
    };

  } catch (err) {
    console.error("Error loadAllData:", err);
    return { produk: [], bundle: [], status: null };
  }
}


    function updateStoreStatusBanner(status){
      const banner = document.getElementById('storeStatusBanner');
      const text = document.getElementById('storeStatusText');

      if(!status){
        banner.className = 'store-status-banner loading';
        text.textContent = 'Status toko tidak tersedia';
        return;
      }

      const statusValue = status.status_toko || status.tutup || status.status || '';
      const isClosed = statusValue.toLowerCase().includes('tutup') || statusValue.toLowerCase() === 'closed';
      
      const catatan = status.catatan || status.pesan_buka || status.pesan_tutup || status.message || '';
      
      if(isClosed){
        banner.className = 'store-status-banner closed';
        text.textContent = 'üî¥ ' + (catatan || 'Toko sedang tutup');
      } else {
        banner.className = 'store-status-banner open';
        text.textContent = 'üü¢ ' + (catatan || 'Toko buka - Silakan belanja');
      }
    }

    async function loadProducts(){
      setSkeleton();
      try{
        const { produk, bundle, status } = await loadAllData();
        
        ALL_PRODUCTS = produk.map((r,i)=>({
          id: String(r.id||r.ID||i+1),
          nama: r.nama||r.name||'Produk',
          harga: Number(r.harga||r.price||0),
          harga_diskon: r.harga_diskon ? Number(r.harga_diskon) : null,
          promo_mulai: r.promo_mulai || null,
          promo_selesai: r.promo_selesai || null,
          aktif_diskon: r.aktif_diskon || 'FALSE',
          satuan: r.satuan||r.unit||'pcs',
          stok: Number(r.stok||r.stock||0),
          gambar: r.gambar||r.image||r.img||'',
          kategori: r.kategori||r.category||'Lainnya',
          deskripsi: r.deskripsi||r.desc||r.description||'',
          isBundle: false
        }));

        ALL_BUNDLES = bundle.map(b=>{
          const prodIds = String(b.produk_ids || b.product_ids || '').split(',').map(x=>x.trim()).filter(Boolean);
          const items = prodIds.map(id=>{
            const p = ALL_PRODUCTS.find(x=>x.id===id);
            return p ? p.nama : null;
          }).filter(Boolean);
          
          const firstProduct = ALL_PRODUCTS.find(x=>x.id===prodIds[0]);
          
          const hasPromo = b.bundle_promo_mulai && b.bundle_promo_selesai;
          let finalPrice = Number(b.harga_bundle||b.harga||0);
          let originalPrice = null;
          
          if(hasPromo && b.harga_bundle_original){
            originalPrice = Number(b.harga_bundle_original);
          }
          
          return {
            id: 'bundle_' + String(b.bundle_id || b.id),
            nama: b.bundle_nama || b.nama || 'Paket Bundle',
            harga_bundle: finalPrice,
            harga_bundle_original: originalPrice,
            produk_ids: prodIds,
            bundleItems: items.length > 0 ? items.join(', ') : 'Paket Hemat',
            gambar: b.bundle_gambar || b.gambar || firstProduct?.gambar || '',
            kategori: firstProduct?.kategori || 'Bundle',
            deskripsi: items.length > 0 ? `Paket hemat berisi: ${items.join(', ')}` : 'Paket hemat produk pilihan',
            satuan: 'paket',
            bundle_stok: Number(b.bundle_stok || 0),
            bundle_promo_mulai: b.bundle_promo_mulai || null,
            bundle_promo_selesai: b.bundle_promo_selesai || null,
            isBundle: true
          };
        }).filter(b => b.harga_bundle > 0);
        
        FILTERED_PRODUCTS = [...ALL_PRODUCTS, ...ALL_BUNDLES];
        updateStoreStatusBanner(status);
        renderCategories();
        applyFilters();
      }catch(err){
        console.error(err);
        document.getElementById('productsGrid').innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-muted)">Gagal memuat produk</div>';
      }
    }

    document.getElementById('brandSection').addEventListener('click', resetToHome);
    document.getElementById('searchInput').addEventListener('input', ()=>{
      clearTimeout(window.searchTimeout);
      window.searchTimeout = setTimeout(applyFilters, 300);
    });
    document.getElementById('filterBtn').addEventListener('click', ()=>{
      document.getElementById('filterModal').classList.add('show');
    });
    document.getElementById('closeFilter').addEventListener('click', ()=>{
      document.getElementById('filterModal').classList.remove('show');
    });
    document.getElementById('headerCartBtn').addEventListener('click', ()=>{
      document.getElementById('cartPanel').classList.add('show');
    });
    document.getElementById('fabCartBtn').addEventListener('click', ()=>{
      document.getElementById('cartPanel').classList.add('show');
    });
    document.getElementById('closeCartBtn').addEventListener('click', ()=>{
      document.getElementById('cartPanel').classList.remove('show');
    });
    document.getElementById('clearCartBtn').addEventListener('click', ()=>{
      if(confirm('Kosongkan keranjang?')) saveCart([]);
    });
    document.getElementById('checkoutBtn').addEventListener('click', doCheckout);
    document.getElementById('loadMoreBtn').addEventListener('click', renderChunk);

    document.getElementById('filterModal').addEventListener('click', (e)=>{
      if(e.target.classList.contains('filter-modal')) closeModal('filterModal');
    });
    document.getElementById('cartPanel').addEventListener('click', (e)=>{
      if(e.target.classList.contains('cart-panel')) closeModal('cartPanel');
    });
    document.getElementById('productModal').addEventListener('click', (e)=>{
      if(e.target.classList.contains('modal-backdrop')) closeModal('productModal');
    });
    document.getElementById('customerModal').addEventListener('click', (e)=>{
      if(e.target.classList.contains('modal-backdrop')) closeModal('customerModal');
    });

    loadProducts();
    renderCart();
    updateCartBadges();

  </script>
</body>
</html>


