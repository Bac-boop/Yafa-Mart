<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Yafa Mart - Katalog</title>
  <style>
    :root{--accent:#0b6efd;--muted:#6b7280;--card:#ffffff;--bg:#f3f4f6}
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;margin:0;background:var(--bg);color:#111}
    header{background:var(--card);padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;box-shadow:0 1px 6px rgba(2,6,23,0.06);position:sticky;top:0;z-index:100}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:44px;height:44px;background:linear-gradient(135deg,var(--accent),#06b6d4);border-radius:8px;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:18px}
    main{max-width:1100px;margin:16px auto;padding:0 12px;display:grid;grid-template-columns:320px 1fr;gap:16px}
    .panel{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 1px 6px rgba(2,6,23,0.03)}
    .search input{width:100%;padding:10px;border-radius:8px;border:1px solid #e5e7eb;font-size:14px}
    .categories{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .chip{padding:8px 12px;border-radius:999px;background:#f8fafc;border:1px solid #e6eef6;cursor:pointer;font-size:14px;transition:all 0.2s}
    .chip:hover{background:#eef5ff}
    .chip.active{background:var(--accent);color:white;border-color:var(--accent)}
    .products{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
    .card{background:white;border-radius:10px;padding:10px;display:flex;flex-direction:column;gap:8px;border:1px solid #eef2ff;transition:all 0.2s}
    .card:hover{box-shadow:0 4px 12px rgba(11,110,253,0.1);transform:translateY(-2px)}
    .img{height:140px;background:linear-gradient(135deg,#eef5ff,#f0f9ff);border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative}
    .img img{width:100%;height:100%;object-fit:cover;transition:opacity 0.3s}
    .img-placeholder{display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--muted);gap:8px}
    .img-placeholder svg{width:48px;height:48px;opacity:0.5}
    .meta{display:flex;justify-content:space-between;align-items:center}
    .price{font-weight:700;color:#111;font-size:16px}
    .stock-badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:12px;font-weight:500}
    .stock-ok{background:#d1fae5;color:#065f46}
    .stock-low{background:#fed7aa;color:#9a3412}
    .stock-out{background:#fecaca;color:#991b1b}
    .btn{background:var(--accent);color:white;padding:8px 14px;border-radius:8px;border:none;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.2s}
    .btn:hover{background:#0952c6;transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid #dbeafe}
    .btn.ghost:hover{background:#eff6ff}
    .btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
    .cart{position:fixed;right:18px;bottom:18px;background:var(--accent);color:white;padding:12px 18px;border-radius:999px;box-shadow:0 8px 20px rgba(11,110,253,0.3);cursor:pointer;transition:all 0.2s;font-weight:500}
    .cart:hover{transform:scale(1.05);box-shadow:0 12px 24px rgba(11,110,253,0.4)}
    .cart-count{background:#ff4636;padding:4px 8px;border-radius:999px;margin-left:8px;font-weight:700;font-size:13px}
    .cart-item{display:flex;justify-content:space-between;gap:8px;padding:8px 0;border-bottom:1px solid #f3f4f6}
    .cart-item:last-child{border-bottom:none}
    .load-more{display:block;margin:14px auto;padding:10px 20px;border-radius:8px;border:1px solid #e6eef6;background:white;cursor:pointer;font-size:14px;transition:all 0.2s}
    .load-more:hover{background:#f8fafc;border-color:var(--accent)}
    .topbar-right{display:flex;gap:8px;align-items:center}
    footer{max-width:1100px;margin:12px auto;padding:8px;text-align:center;color:var(--muted);font-size:13px}
    .skeleton{background:linear-gradient(90deg,#edf2ff 25%,#f8fafc 50%,#edf2ff 75%);background-size:200% 100%;animation:shimmer 1.2s linear infinite;border-radius:8px}
    @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .empty-state{text-align:center;padding:40px 20px;color:var(--muted)}
    .empty-state svg{width:64px;height:64px;margin-bottom:16px;opacity:0.5}
    .status-badge{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:500}
    .status-live{background:#d1fae5;color:#065f46}
    .status-demo{background:#fee2e2;color:#991b1b}
    
    @media (max-width:900px){
      main{grid-template-columns:1fr;padding:12px}
      .panel.left{order:2}
      .topbar-right{font-size:11px}
      header{padding:8px 12px}
      .brand>div>div{font-size:12px}
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">YM</div>
      <div>
        <div style="font-weight:700">Yafa Mart</div>
        <div style="font-size:13px;color:var(--muted)">Katalog Online ‚Äî COD via WhatsApp</div>
      </div>
    </div>
    <div class="topbar-right">
      <span id="dataStatus" class="status-badge status-demo">Loading...</span>
      <button class="btn" id="exportCsv">Export CSV</button>
      <button class="btn ghost" id="testWa" title="Test WhatsApp Connection">üì± Test WA</button>
      <div style="font-size:13px;color:var(--muted)">Admin WA: <span id="adminWaLabel">-</span></div>
    </div>
  </header>

  <main>
    <aside class="panel left">
      <div class="search">
        <input id="q" placeholder="üîç Cari produk... contoh: beras, minyak" />
      </div>
      <div class="categories" id="categories"></div>
      <hr style="margin:12px 0;border:none;border-top:1px solid #f3f4f6" />
      <div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:700">üõí Keranjang</div>
          <div style="font-size:13px;color:var(--muted)" id="cart-summary">0 item</div>
        </div>
        <div id="cart-items"></div>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn" id="checkoutBtn">Checkout via WhatsApp</button>
          <button class="btn ghost" id="clearCart">Kosongkan</button>
        </div>
      </div>
    </aside>

    <section class="panel right">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div style="font-weight:700">üì¶ Daftar Produk</div>
        <div style="font-size:13px;color:var(--muted)">Tampilkan <span id="visibleCount">0</span> dari <span id="totalCount">0</span></div>
      </div>
      <div class="products" id="products"></div>
      <button id="loadMore" class="load-more">Muat lebih banyak</button>
    </section>
  </main>

  <button class="cart" id="floatingCart" style="display:none">
    üõí Keranjang <span class="cart-count" id="floatingCount">0</span>
  </button>

  <footer>
    <div>Katalog Online Yafa Mart - Terhubung dengan Google Sheet via SheetDB</div>
  </footer>

  <script>
    /***** CONFIG - EDIT THIS *****/
    const ADMIN_WHATSAPP = '6285816381285'; // Format: 62xxx (Indonesia) tanpa tanda + atau spasi
    const SHOP_NAME = 'Yafa Mart';
    const SHEET_API = 'https://sheetdb.io/api/v1/rcorje2n3osn1';
    const PAGE_SIZE = 20;
    /***** END CONFIG *****/

    // Validate WhatsApp number on page load
    if(!ADMIN_WHATSAPP || ADMIN_WHATSAPP === '') {
      console.error('‚ö†Ô∏è ADMIN_WHATSAPP belum diset!');
      alert('PERHATIAN: Nomor WhatsApp admin belum dikonfigurasi!');
    } else {
      console.log('‚úÖ WhatsApp admin configured:', ADMIN_WHATSAPP);
    }

    document.getElementById('adminWaLabel').textContent = ADMIN_WHATSAPP;

    // Helper functions
    function formatRp(n){ 
      return 'Rp ' + Number(n).toLocaleString('id-ID'); 
    }
    
    function getImageUrl(url, id) {
      if (!url || url.trim() === '') {
        return null;
      }
      // Handle various URL formats
      if (url.startsWith('http://') || url.startsWith('https://')) {
        return url;
      }
      // If it's a Google Drive link, convert to direct link
      if (url.includes('drive.google.com')) {
        const fileId = url.match(/\/d\/(.+?)\//) || url.match(/id=(.+?)(&|$)/);
        if (fileId && fileId[1]) {
          return `https://drive.google.com/uc?export=view&id=${fileId[1]}`;
        }
      }
      return url;
    }

    // State management
    let ALL_PRODUCTS = [];
    let FILTERED_PRODUCTS = [];
    let displayOffset = 0;
    let isDataFromSheet = false;
    const CART_KEY = 'yafa_cart_v1';

    // Storage helpers
    function loadCart(){ 
      try{ 
        return JSON.parse(localStorage.getItem(CART_KEY) || '[]'); 
      }catch(e){
        return [];
      } 
    }
    
    function saveCart(c){ 
      localStorage.setItem(CART_KEY, JSON.stringify(c)); 
      renderCart(); 
      updateFloating(); 
    }

    // Rendering functions
    function setSkeleton(target, count=6){ 
      const container = document.getElementById(target); 
      container.innerHTML=''; 
      for(let i=0; i<count; i++){ 
        const card = document.createElement('div'); 
        card.className='card'; 
        card.innerHTML = '<div class="img skeleton" style="height:140px"></div><div class="skeleton" style="height:16px;width:60%;margin-top:8px"></div><div class="skeleton" style="height:12px;width:40%;margin-top:4px"></div>'; 
        container.appendChild(card); 
      } 
    }

    function getStockBadge(stok) {
      if (stok === 0) return '<span class="stock-badge stock-out">Habis</span>';
      if (stok < 10) return '<span class="stock-badge stock-low">Stok: ' + stok + '</span>';
      return '<span class="stock-badge stock-ok">Stok: ' + stok + '</span>';
    }

    function renderProductsChunk(){ 
      const container = document.getElementById('products'); 
      const chunk = FILTERED_PRODUCTS.slice(displayOffset, displayOffset + PAGE_SIZE); 
      
      if (chunk.length === 0 && displayOffset === 0) {
        container.innerHTML = `
          <div class="empty-state" style="grid-column:1/-1">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path></svg>
            <div style="font-size:16px;font-weight:500;margin-bottom:4px">Produk tidak ditemukan</div>
            <div>Coba kata kunci lain atau pilih kategori berbeda</div>
          </div>
        `;
        return;
      }
      
      chunk.forEach(p=>{ 
        const el = document.createElement('div'); 
        el.className='card';
        const imageUrl = getImageUrl(p.gambar, p.id);
        const imageHtml = imageUrl 
          ? `<img loading="lazy" src="${imageUrl}" alt="${p.nama}" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
             <div class="img-placeholder" style="display:none">
               <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
               <div style="font-size:12px">Gambar tidak tersedia</div>
             </div>`
          : `<div class="img-placeholder">
               <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
               <div style="font-size:12px">Gambar tidak tersedia</div>
             </div>`;
        
        el.innerHTML = `
          <div class="img">${imageHtml}</div>
          <div style="font-weight:700;font-size:15px">${p.nama}</div>
          <div style="font-size:13px;color:var(--muted);line-height:1.4">${p.deskripsi || ''}</div>
          <div class="meta" style="margin-top:auto">
            <div>
              <div class="price">${formatRp(p.harga)}</div>
              <div style="font-size:12px;color:var(--muted)">per ${p.satuan || 'pcs'}</div>
            </div>
            ${getStockBadge(p.stok)}
          </div>
          <div style="display:flex;gap:8px;margin-top:6px;align-items:center">
            <input type="number" min="1" max="${p.stok}" value="1" style="width:70px;padding:8px;border-radius:6px;border:1px solid #e5e7eb;font-size:14px" id="qty_${p.id}" ${p.stok === 0 ? 'disabled' : ''} />
            <button class="btn" data-id="${p.id}" ${p.stok === 0 ? 'disabled' : ''}>
              ${p.stok === 0 ? 'Habis' : '+ Keranjang'}
            </button>
          </div>
        `; 
        container.appendChild(el); 
      });
      
      // Attach event handlers
      document.querySelectorAll('.card .btn[data-id]').forEach(b=>{ 
        if(!b._attached && !b.disabled){ 
          b._attached = true; 
          b.addEventListener('click', ()=>{ 
            const id = b.getAttribute('data-id'); 
            const qtyInput = document.getElementById('qty_'+id);
            const qty = parseInt(qtyInput.value) || 1; 
            addToCart(id, qty); 
          }); 
        } 
      });
      
      displayOffset += chunk.length; 
      updateCounts();
      
      // Hide load more if at end
      document.getElementById('loadMore').style.display = displayOffset >= FILTERED_PRODUCTS.length ? 'none' : 'block';
    }

    function updateCounts(){ 
      document.getElementById('visibleCount').textContent = Math.min(displayOffset, FILTERED_PRODUCTS.length); 
      document.getElementById('totalCount').textContent = FILTERED_PRODUCTS.length; 
    }

    function renderCategories(){ 
      const cats = Array.from(new Set(ALL_PRODUCTS.map(p=>p.kategori))).sort(); 
      const container = document.getElementById('categories'); 
      container.innerHTML=''; 
      
      const all = document.createElement('div'); 
      all.className='chip active'; 
      all.textContent='Semua'; 
      all.dataset.cat=''; 
      container.appendChild(all); 
      
      cats.forEach(c=>{ 
        const el = document.createElement('div'); 
        el.className='chip'; 
        el.textContent=c; 
        el.dataset.cat=c; 
        container.appendChild(el); 
      }); 
      
      container.querySelectorAll('.chip').forEach(ch=> 
        ch.addEventListener('click', ()=>{ 
          container.querySelectorAll('.chip').forEach(x=>x.classList.remove('active')); 
          ch.classList.add('active'); 
          applyFilters(); 
        })
      ); 
    }

    function applyFilters(){ 
      const q = document.getElementById('q').value.trim().toLowerCase(); 
      const active = document.querySelector('.chip.active')?.dataset?.cat || ''; 
      
      FILTERED_PRODUCTS = ALL_PRODUCTS.filter(p=> 
        (active === '' || p.kategori === active) && 
        (q === '' || 
         p.nama.toLowerCase().includes(q) || 
         (p.deskripsi || '').toLowerCase().includes(q) ||
         (p.kategori || '').toLowerCase().includes(q))
      ); 
      
      // Reset display
      displayOffset = 0; 
      const container = document.getElementById('products'); 
      container.innerHTML = ''; 
      renderProductsChunk(); 
    }

    // Cart functions
    function addToCart(id, qty){ 
      const p = ALL_PRODUCTS.find(x=>x.id===id); 
      if(!p) return alert('Produk tidak ditemukan'); 
      if(p.stok === 0) return alert('Produk habis'); 
      if(qty > p.stok) return alert('Stok tidak cukup. Stok tersedia: ' + p.stok); 
      
      const cart = loadCart(); 
      const item = cart.find(i=>i.id===id); 
      
      if(item){ 
        if(item.qty + qty > p.stok) return alert('Jumlah melebihi stok. Stok tersedia: ' + p.stok); 
        item.qty += qty;
      } else {
        cart.push({
          id: id,
          name: p.nama,
          price: p.harga,
          unit: p.satuan || 'pcs',
          qty: qty
        });
      }
      
      saveCart(cart); 
      
      // Visual feedback
      const btn = document.querySelector(`button[data-id="${id}"]`);
      if(btn){
        const original = btn.textContent;
        btn.textContent = '‚úì Ditambahkan';
        btn.style.background = '#10b981';
        setTimeout(()=>{
          btn.textContent = original;
          btn.style.background = '';
        }, 1000);
      }
    }

    function renderCart(){ 
      const container = document.getElementById('cart-items'); 
      const cart = loadCart(); 
      container.innerHTML=''; 
      
      if(cart.length === 0){ 
        container.innerHTML='<div style="color:var(--muted);text-align:center;padding:20px 0">Keranjang kosong</div>'; 
        document.getElementById('cart-summary').textContent = '0 item'; 
        return;
      } 
      
      cart.forEach(i=>{ 
        const row = document.createElement('div'); 
        row.className = 'cart-item';
        row.innerHTML = `
          <div style="flex:1">
            <div style="font-weight:600;font-size:14px">${i.name}</div>
            <div style="font-size:13px;color:var(--muted);margin-top:2px">${i.qty} √ó ${formatRp(i.price)}</div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:700;color:var(--accent)">${formatRp(i.qty * i.price)}</div>
            <button class="btn ghost" data-id="remove_${i.id}" style="margin-top:4px;padding:4px 8px;font-size:12px">Hapus</button>
          </div>
        `; 
        container.appendChild(row); 
      }); 
      
      container.querySelectorAll('button[data-id^="remove_"]').forEach(b=> 
        b.addEventListener('click', ()=>{ 
          const id = b.dataset.id.replace('remove_',''); 
          removeFromCart(id);
        })
      ); 
      
      const total = cart.reduce((s,i) => s + i.price * i.qty, 0); 
      document.getElementById('cart-summary').textContent = `${cart.length} item ‚Äî ${formatRp(total)}`; 
    }

    function removeFromCart(id){ 
      const cart = loadCart().filter(i=>i.id !== id); 
      saveCart(cart); 
    }

    document.getElementById('clearCart').addEventListener('click', ()=>{ 
      if(confirm('Kosongkan keranjang?')){ 
        saveCart([]);
      } 
    });

    // Checkout
    document.getElementById('checkoutBtn').addEventListener('click', ()=> doCheckout());
    document.getElementById('floatingCart').addEventListener('click', ()=> {
      window.scrollTo({top: 0, behavior: 'smooth'});
    });

    async function doCheckout(){ 
      const cart = loadCart(); 
      if(cart.length === 0) return alert('Keranjang kosong'); 
      
      // Collect customer data
      const name = prompt('üìù Nama Lengkap Anda:'); 
      if(!name || name.trim() === '') return alert('Nama harus diisi!'); 
      
      const phone = prompt('üì± Nomor HP/WhatsApp Anda:\n(contoh: 081234567890)'); 
      if(!phone || phone.trim() === '') return alert('Nomor HP harus diisi!'); 
      
      const address = prompt('üìç Alamat Lengkap Pengiriman:\n(Jalan, RT/RW, Kelurahan, Kecamatan, Kota)'); 
      if(!address || address.trim() === '') return alert('Alamat harus diisi!'); 
      
      const note = prompt('üìã Catatan Tambahan (opsional):\n(contoh: warna, ukuran, dll)', ''); 
      
      // Get current date and time
      const now = new Date();
      const tanggal = now.toLocaleDateString('id-ID', { 
        day: '2-digit', 
        month: 'long', 
        year: 'numeric' 
      });
      const waktu = now.toLocaleTimeString('id-ID', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
      
      // Build WhatsApp message with better formatting
      let text = `‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
   üõí *PESANAN BARU*
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

üìÖ *Tanggal:* ${tanggal}
‚è∞ *Waktu:* ${waktu}

üë§ *DATA PELANGGAN*
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ Nama: ${name}
‚Ä¢ No HP: ${phone}
‚Ä¢ Alamat: ${address}

üõçÔ∏è *DETAIL PESANAN*
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
`;
      
      let no = 1;
      cart.forEach(i=>{ 
        text += `${no}. ${i.name}
   ${i.qty} √ó ${formatRp(i.price)} = ${formatRp(i.qty * i.price)}

`; 
        no++;
      });
      
      const subtotal = cart.reduce((s,i) => s + i.qty * i.price, 0);
      text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üí∞ *TOTAL: ${formatRp(subtotal)}*
üí≥ Metode: *COD (Bayar di Tempat)*`;
      
      if(note && note.trim() !== '') {
        text += `

üìù *Catatan:*
${note}`;
      }
      
      text += `

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Terima kasih sudah berbelanja di *${SHOP_NAME}* üôè

_Pesanan akan segera kami proses_`;

      // Try to update stock in Google Sheet (if using SheetDB)
      if(isDataFromSheet && SHEET_API) {
        try {
          await updateStockInSheet(cart);
          console.log('Stok berhasil diupdate di Google Sheet');
        } catch(e) {
          console.warn('Gagal update stok di Google Sheet:', e);
        }
      }

      // Clear cart
      saveCart([]);
      
      // Open WhatsApp - IMPORTANT: This must happen AFTER stock update
      const wa = `https://wa.me/${ADMIN_WHATSAPP}?text=${encodeURIComponent(text)}`;
      console.log('Opening WhatsApp to:', ADMIN_WHATSAPP);
      console.log('WhatsApp URL:', wa);
      
      window.open(wa, '_blank');
      
      // Show success message
      alert('‚úÖ Pesanan berhasil dikirim ke WhatsApp admin!\n\nSilakan cek WhatsApp Anda untuk melanjutkan.');
      
      // Reload products to show updated stock
      setTimeout(() => {
        loadAllProducts();
      }, 1000);


      // Try to update stock in Google Sheet (if using SheetDB)
      if(isDataFromSheet && SHEET_API) {
        try {
          await updateStockInSheet(cart);
          alert('Pesanan berhasil! Stok telah diperbarui di Google Sheet.');
        } catch(e) {
          console.warn('Gagal update stok di Google Sheet:', e);
          alert('Pesanan dikirim, tapi stok gagal diperbarui otomatis. Admin akan update manual.');
        }
      }

      // Clear cart
      saveCart([]);
      
      // Open WhatsApp
      const wa = `https://wa.me/${ADMIN_WHATSAPP}?text=` + encodeURIComponent(text);
      window.open(wa, '_blank');
      
      // Reload products to show updated stock
      setTimeout(() => {
        loadAllProducts();
      }, 1000);
    }

    async function updateStockInSheet(cart) {
      // Update stock for each item in cart via SheetDB API
      for(const item of cart) {
        const product = ALL_PRODUCTS.find(p => p.id === item.id);
        if(!product) continue;
        
        const newStock = Math.max(0, product.stok - item.qty);
        
        try {
          // SheetDB: Update by searching for id column
          const updateUrl = `${SHEET_API}/id/${item.id}`;
          const response = await fetch(updateUrl, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              stok: newStock
            })
          });
          
          if(!response.ok) {
            throw new Error('Update failed for product ' + item.id);
          }
          
          // Update local product data
          product.stok = newStock;
        } catch(e) {
          console.error('Error updating stock for', item.id, e);
          throw e;
        }
      }
    }

    // Floating cart
    function updateFloating(){ 
      const cart = loadCart(); 
      const cnt = cart.reduce((s,i)=>s+i.qty, 0); 
      document.getElementById('floatingCount').textContent = cnt; 
      document.getElementById('floatingCart').style.display = cnt ? 'inline-block' : 'none'; 
    }

    // Export CSV
    document.getElementById('exportCsv').addEventListener('click', ()=>{ 
      const header = ['id','nama','harga','satuan','stok','gambar','kategori','deskripsi']; 
      const rows = ALL_PRODUCTS.map(p=> {
        return header.map(h => {
          const value = p[h] !== undefined ? p[h] : '';
          return '"' + String(value).replace(/"/g, '""') + '"';
        }).join(',');
      }); 
      const csv = [header.join(',')].concat(rows).join('\n'); 
      const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'}); 
      const url = URL.createObjectURL(blob); 
      const a = document.createElement('a'); 
      a.href = url; 
      a.download = 'yafa_products_' + new Date().toISOString().split('T')[0] + '.csv'; 
      a.click(); 
      URL.revokeObjectURL(url); 
    });

    // Test WhatsApp button
    document.getElementById('testWa').addEventListener('click', ()=>{
      const testMessage = `Halo, ini adalah test pesan dari website ${SHOP_NAME}. ‚úÖ`;
      const wa = `https://wa.me/${ADMIN_WHATSAPP}?text=${encodeURIComponent(testMessage)}`;
      console.log('Test WhatsApp URL:', wa);
      window.open(wa, '_blank');
      alert('‚úÖ WhatsApp test dibuka!\n\nJika tidak muncul, periksa:\n1. Nomor WA sudah benar (format: 62xxx)\n2. Browser tidak memblokir popup\n3. WhatsApp sudah terinstall');
    });

    // Search input handler
    document.getElementById('q').addEventListener('input', ()=> {
      applyFilters();
    });

    // Load more handler
    document.getElementById('loadMore').addEventListener('click', ()=> renderProductsChunk());

    // Main function to load products from Google Sheet
    async function loadAllProducts(){ 
      setSkeleton('products', 8);
      
      const statusBadge = document.getElementById('dataStatus');
      statusBadge.textContent = 'Loading...';
      statusBadge.className = 'status-badge status-demo';
      
      try {
        if(!SHEET_API) {
          throw new Error('Sheet API not configured');
        }

        console.log('Fetching from SheetDB:', SHEET_API);
        const response = await fetch(SHEET_API);
        
        if(!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Data received:', data);
        
        if(!Array.isArray(data) || data.length === 0) {
          throw new Error('No data received from Google Sheet');
        }

        // Normalize data from Google Sheet
        ALL_PRODUCTS = data.map((row, index) => {
          // Handle different possible column names from your sheet
          return {
            id: String(row.id || row.ID || index + 1),
            nama: row.nama || row.name || 'Produk Tanpa Nama',
            harga: Number(row.harga || row.price || 0),
            satuan: row.satuan || row.unit || 'pcs',
            stok: Number(row.stok || row.stock || 0),
            gambar: row.gambar || row.image || row.img || '',
            kategori: row.kategori || row.category || 'Lainnya',
            deskripsi: row.deskripsi || row.desc || row.description || ''
          };
        });

        console.log('Products loaded:', ALL_PRODUCTS.length);
        isDataFromSheet = true;
        
        statusBadge.textContent = 'üü¢ Live dari Google Sheet';
        statusBadge.className = 'status-badge status-live';
        
      } catch(error) {
        console.error('Error loading from Google Sheet:', error);
        
        // Fallback: show error message
        ALL_PRODUCTS = [];
        isDataFromSheet = false;
        
        statusBadge.textContent = '‚ùå Gagal memuat data';
        statusBadge.className = 'status-badge status-demo';
        
        alert('Gagal memuat produk dari Google Sheet. Periksa:\n\n' +
              '1. Koneksi internet Anda\n' +
              '2. URL SheetDB API sudah benar\n' +
              '3. Google Sheet bisa diakses public\n\n' +
              'Error: ' + error.message);
      }
      
      // Reset filters and render
      FILTERED_PRODUCTS = [...ALL_PRODUCTS];
      displayOffset = 0;
      
      const container = document.getElementById('products');
      container.innerHTML = '';
      
      renderCategories();
      renderProductsChunk();
      renderCart();
      updateFloating();
    }

    // Initialize on page load
    loadAllProducts();
    renderCart();
    updateFloating();

  </script>
</body>
</html>
